<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- API å®‰å…¨æ€§è¨­å®š -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    
    <!-- ç¶²é åœ–ç¤º -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”’</text></svg>">
    
    <title>Virtual Wardrobe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, getDoc, setDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.Firebase = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, deleteDoc, doc, getDoc, setDoc, onSnapshot, query, orderBy, serverTimestamp };
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans">
    
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        //  ã€è«‹å‹™å¿…å¡«å¯«é€™è£¡ã€‘
        // ==========================================

        const API_KEY = "AIzaSyAojHhJ38PbIayu8MBrqJ3_W0areVGcykU"; 

        // è«‹åˆ° Firebase Console -> å°ˆæ¡ˆè¨­å®š -> è¤‡è£½ sdk config    
        const YOUR_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDO31PRKXec6po5prR0CquPxiqRfubS9KQ",
        authDomain: "virtual-wardrobe-photos.firebaseapp.com",
        projectId: "virtual-wardrobe-photos",
        storageBucket: "virtual-wardrobe-photos.firebasestorage.app",
        messagingSenderId: "96273892644",
        appId: "1:96273892644:web:3008f7f604c57669f35fb1"
        };

        // ==========================================

        const { useState, useRef, useEffect } = React;

        // --- åœ–ç‰‡å£“ç¸®å·¥å…· ---
        const compressImage = (base64Str, maxWidth = 800, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        };

        // --- åœ–ç¤ºå…ƒä»¶ ---
        const Icons = {
            Shirt: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></svg>,
            Grid: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Watch: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="6"/><polyline points="12 10 12 12 13 13"/><path d="m16.13 7.66-.81-4.05a2 2 0 0 0-2.53-1.46l-4.24.85a2 2 0 0 0-1.46 2.53l.81 4.05"/><path d="m7.88 16.34.81 4.05a2 2 0 0 0 2.53 1.46l4.24-.85a2 2 0 0 0 1.46-2.53l-.81-4.05"/></svg>,
            Loader: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            CloudCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" opacity="0.1"/><path d="m9 12 2 2 4-4"/></svg>,
            BookHeart: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M12 8c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2z"/><path d="M8 8h.01"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            SaveHeart: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        };

        const generateTryOnImage = async (userImage, selectedItems, apiKey) => {
            if (!apiKey) throw new Error("API Key æœªè¨­å®š");
            let promptText = "é€™æ˜¯ä¸€é …è™›æ“¬è©¦ç©¿ä»»å‹™ã€‚ç¬¬ä¸€å¼µåœ–ç‰‡æ˜¯'ä½¿ç”¨è€…' (æ¨¡ç‰¹å…’)ã€‚";
            const imageParts = [];
            imageParts.push({ inlineData: { mimeType: "image/jpeg", data: userImage.split(',')[1] } });
            
            let clothIndex = 2;
            if (selectedItems.upper) { promptText += ` ç¬¬ ${clothIndex} å¼µåœ–ç‰‡æ˜¯'ä¸Šèº«è¡£ç‰©'ã€‚`; imageParts.push({ inlineData: { mimeType: "image/jpeg", data: selectedItems.upper.src.split(',')[1] } }); clothIndex++; }
            if (selectedItems.lower) { promptText += ` ç¬¬ ${clothIndex} å¼µåœ–ç‰‡æ˜¯'ä¸‹èº«è¡£ç‰©'ã€‚`; imageParts.push({ inlineData: { mimeType: "image/jpeg", data: selectedItems.lower.src.split(',')[1] } }); clothIndex++; }
            if (selectedItems.accessory) { promptText += ` ç¬¬ ${clothIndex} å¼µåœ–ç‰‡æ˜¯'æ™‚å°šé…ä»¶'ã€‚`; imageParts.push({ inlineData: { mimeType: "image/jpeg", data: selectedItems.accessory.src.split(',')[1] } }); clothIndex++; }
            
            promptText += " è«‹ç”Ÿæˆä¸€å¼µé«˜å“è³ªã€å¯«å¯¦çš„ç…§ç‰‡ï¼Œé¡¯ç¤º'ä½¿ç”¨è€…'ç©¿è‘—ä¸Šè¿°é¸å®šçš„è¡£ç‰©/é…ä»¶ã€‚ [é‡è¦æŒ‡ä»¤]ï¼š1. è«‹å°‡èƒŒæ™¯æ›¿æ›ç‚º'ç´”ç™½è‰²æ”å½±æ£šèƒŒæ™¯'ã€‚ 2. æ¨¡ç‰¹å…’è«‹å‘ˆç¾'æ­£é¢å…¨èº«'ã€‚";

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }, ...imageParts] }],
                            generationConfig: { responseModalities: ["IMAGE"], temperature: 0.4 }
                        }),
                    }
                );
                const data = await response.json();
                if (data.error) throw new Error(data.error.message || "API æ¬Šé™éŒ¯èª¤");
                if (data.candidates?.[0]?.content?.parts) {
                    const imagePart = data.candidates[0].content.parts.find(p => p.inlineData);
                    if (imagePart) return `data:image/jpeg;base64,${imagePart.inlineData.data}`;
                }
                throw new Error("ç”Ÿæˆå›æ‡‰ä¸­æ²’æœ‰åœ–ç‰‡");
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        // --- è¨­å®šå½ˆå‡ºè¦–çª— ---
        const SettingsModal = ({ onClose, user, isFirebaseReady }) => {
            const [newPassword, setNewPassword] = useState('');
            const [msg, setMsg] = useState('');

            const handleSavePassword = async () => {
                if (!isFirebaseReady) {
                    setMsg('âŒ å°šæœªé€£ç·šåˆ°é›²ç«¯ï¼Œç„¡æ³•ä¿®æ”¹');
                    return;
                }
                if (!newPassword) {
                    setMsg('âš ï¸ å¯†ç¢¼ä¸èƒ½ç‚ºç©º');
                    return;
                }
                try {
                    const db = window.Firebase.getFirestore();
                    await window.Firebase.setDoc(window.Firebase.doc(db, 'app_config', 'lock'), { password: newPassword });
                    setMsg('âœ… å¯†ç¢¼å·²æ›´æ–°ï¼ä¸‹æ¬¡è«‹ç”¨æ–°å¯†ç¢¼ç™»å…¥');
                    setNewPassword('');
                } catch (err) {
                    console.error(err);
                    setMsg('âŒ æ›´æ–°å¤±æ•— (è«‹æª¢æŸ¥æ¬Šé™)');
                }
            };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden p-6 m-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg flex items-center gap-2">
                                <div className="w-5 h-5 text-slate-500"><Icons.Settings /></div> è¨­å®š
                            </h3>
                            <button onClick={onClose}><div className="w-5 h-5"><Icons.X /></div></button>
                        </div>
                        
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-500 mb-1">é€£ç·šç‹€æ…‹</label>
                                <div className={`px-3 py-2 rounded-lg text-sm ${isFirebaseReady ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>
                                    {isFirebaseReady ? 'âœ… å·²é€£ç·šè‡³ Firebase' : 'âš ï¸ æœ¬åœ°æ¨¡å¼ (æœªè¨­å®š Config)'}
                                </div>
                            </div>

                            {user && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-500 mb-1">User ID</label>
                                    <div className="px-3 py-2 bg-gray-100 rounded-lg text-xs font-mono break-all select-all">
                                        {user.uid}
                                    </div>
                                    <p className="text-[10px] text-gray-400 mt-1">Firestore è·¯å¾‘: /users/{user.uid}</p>
                                </div>
                            )}

                            {isFirebaseReady && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-500 mb-1">ä¿®æ”¹é–å®šå¯†ç¢¼</label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            value={newPassword}
                                            onChange={(e) => setNewPassword(e.target.value)}
                                            placeholder="è¼¸å…¥æ–°å¯†ç¢¼"
                                            className="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-1 focus:ring-purple-500 outline-none text-sm"
                                        />
                                        <button onClick={handleSavePassword} className="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-700">å„²å­˜</button>
                                    </div>
                                    {msg && <p className="text-xs mt-2 text-center font-medium animate-pulse">{msg}</p>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- å¯†ç¢¼é–å®šé é¢ ---
        const LockScreen = ({ onUnlock, isFirebaseReady }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState(false);
            const [verifying, setVerifying] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(false);
                setVerifying(true);

                if (!isFirebaseReady) {
                    if (input === "1234") { // æœ¬åœ°ç·Šæ€¥å¾Œé–€
                        onUnlock();
                        return;
                    }
                    alert("âš ï¸ é›²ç«¯é€£ç·šä¸­... è«‹ç¨å¾Œå†è©¦ã€‚");
                    setVerifying(false);
                    return;
                }

                try {
                    const db = window.Firebase.getFirestore();
                    const docRef = window.Firebase.doc(db, 'app_config', 'lock');
                    const docSnap = await window.Firebase.getDoc(docRef);

                    if (docSnap.exists()) {
                        const correctPassword = docSnap.data().password;
                        if (input === correctPassword) {
                            onUnlock();
                        } else {
                            setError(true);
                            setInput('');
                        }
                    } else {
                        await window.Firebase.setDoc(docRef, { password: "1234" });
                        alert("é¦–æ¬¡ä½¿ç”¨ï¼Œé è¨­å¯†ç¢¼ï¼š1234");
                        if (input === "1234") onUnlock(); else setInput('1234');
                    }
                } catch (err) {
                    console.error("Auth Error", err);
                    if (err.code === 'permission-denied') {
                        // æ¬Šé™éŒ¯èª¤æ™‚çš„ç·Šæ€¥è™•ç†
                        if (confirm("âš ï¸ æ¬Šé™éŒ¯èª¤ï¼šç„¡æ³•è®€å–å¯†ç¢¼æª”æ¡ˆã€‚\n\né€™é€šå¸¸æ˜¯å› ç‚º Firestore è¦å‰‡æœªè¨­å®šå…è¨± 'app_config/lock' è®€å–ã€‚\n\næ˜¯å¦ä½¿ç”¨å‚™ç”¨å¯†ç¢¼ '1234' æš«æ™‚é€²å…¥æœ¬åœ°æ¨¡å¼ï¼Ÿ")) {
                            if (input === "1234") onUnlock();
                            else {
                                alert("è«‹è¼¸å…¥å‚™ç”¨å¯†ç¢¼ï¼š1234");
                                setInput('1234');
                            }
                        }
                    } else {
                        alert("é©—è­‰éŒ¯èª¤: " + err.message);
                    }
                } finally {
                    setVerifying(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-white p-4">
                    <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700">
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 bg-gradient-to-tr from-purple-600 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg">
                                {verifying ? <div className="animate-spin"><Icons.Loader /></div> : <Icons.Lock />}
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center mb-2">Virtual Wardrobe</h2>
                        <p className="text-slate-400 text-center mb-8 flex justify-center items-center gap-2">
                            {isFirebaseReady ? <span className="text-green-400 text-xs">â— é›²ç«¯å·²é€£ç·š</span> : <span className="text-orange-400 text-xs">â— ç­‰å¾…é€£ç·š / æœ¬åœ°æ¨¡å¼</span>}
                        </p>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input 
                                type="password" 
                                value={input}
                                onChange={(e) => { setInput(e.target.value); setError(false); }}
                                placeholder="è«‹è¼¸å…¥å¯†ç¢¼..."
                                className="w-full px-4 py-3 rounded-xl bg-slate-900 border border-slate-600 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition-all text-center text-lg tracking-widest placeholder:tracking-normal"
                                autoFocus
                                disabled={verifying}
                            />
                            {error && <p className="text-red-400 text-sm text-center animate-pulse">å¯†ç¢¼éŒ¯èª¤</p>}
                            <button type="submit" disabled={verifying} className={`w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 font-bold hover:shadow-lg hover:scale-[1.02] transition-all flex items-center justify-center gap-2 ${verifying ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                {verifying ? 'é©—è­‰ä¸­...' : 'è§£é–é€²å…¥'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- ä¸»æ‡‰ç”¨ ---
        const StyleMate = () => {
            const [isLocked, setIsLocked] = useState(true);
            const [showSettings, setShowSettings] = useState(false);
            const [activeTab, setActiveTab] = useState('wardrobe');
            const [clothes, setClothes] = useState([]);
            const [users, setUsers] = useState([]);
            const [looks, setLooks] = useState([]);
            const [user, setAuthUser] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);

            // è©¦ç©¿ç‹€æ…‹
            const [selectedItems, setSelectedItems] = useState({ upper: null, lower: null, accessory: null });
            const [selectedUser, setSelectedUser] = useState(null);
            const [uploadCategory, setUploadCategory] = useState('upper');
            const [generatedResult, setGeneratedResult] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [isSelectorOpen, setIsSelectorOpen] = useState(false);
            const [currentSelectionSlot, setCurrentSelectionSlot] = useState(null);

            const fileInputRefCloth = useRef(null);
            const fileInputRefUser = useRef(null);

            // 1. åˆå§‹åŒ– Firebase
            useEffect(() => {
                const initFirebase = async () => {
                    if (!YOUR_FIREBASE_CONFIG.apiKey) return;
                    try {
                        let app;
                        try { app = window.Firebase.initializeApp(YOUR_FIREBASE_CONFIG); } 
                        catch(e) { app = window.Firebase.getApp(); }
                        const auth = window.Firebase.getAuth(app);
                        await window.Firebase.signInAnonymously(auth);
                        window.Firebase.onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setAuthUser(u);
                                setIsFirebaseReady(true);
                            }
                        });
                    } catch (err) { console.error("Firebase Init Error:", err); }
                };
                if (window.Firebase) initFirebase();
            }, []); 

            // 2. ç›£è½è³‡æ–™åº«
            useEffect(() => {
                if (isLocked || !user || !isFirebaseReady) return;
                setIsSyncing(true);
                const db = window.Firebase.getFirestore();
                const unsubClothes = window.Firebase.onSnapshot(window.Firebase.query(window.Firebase.collection(db, 'users', user.uid, 'clothes'), window.Firebase.orderBy('createdAt', 'desc')), (s) => setClothes(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubUsers = window.Firebase.onSnapshot(window.Firebase.query(window.Firebase.collection(db, 'users', user.uid, 'models'), window.Firebase.orderBy('createdAt', 'desc')), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubLooks = window.Firebase.onSnapshot(window.Firebase.query(window.Firebase.collection(db, 'users', user.uid, 'looks'), window.Firebase.orderBy('createdAt', 'desc')), (s) => { setLooks(s.docs.map(d => ({ id: d.id, ...d.data() }))); setIsSyncing(false); });
                return () => { unsubClothes(); unsubUsers(); unsubLooks(); };
            }, [user, isFirebaseReady, isLocked]);

            const handleUpload = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const compressedBase64 = await compressImage(reader.result, 800, 0.6);
                    if (isFirebaseReady && user) {
                        try {
                            const db = window.Firebase.getFirestore();
                            const collectionName = type === 'cloth' ? 'clothes' : 'models';
                            const newItem = { src: compressedBase64, name: type === 'cloth' ? "æ–°è¡£æœ" : "æˆ‘", createdAt: window.Firebase.serverTimestamp() };
                            if (type === 'cloth') newItem.category = uploadCategory;
                            await window.Firebase.addDoc(window.Firebase.collection(db, 'users', user.uid, collectionName), newItem);
                        } catch (err) { alert("ä¸Šå‚³å¤±æ•—: " + err.message); }
                    } else {
                        const newItem = { id: Date.now(), src: compressedBase64, name: "æœ¬åœ°", category: uploadCategory };
                        if (type === 'cloth') setClothes([newItem, ...clothes]); else setUsers([newItem, ...users]);
                    }
                };
                reader.readAsDataURL(file);
            };

            const handleSaveLook = async () => {
                if (!generatedResult || !isFirebaseReady || !user) return;
                try {
                    const db = window.Firebase.getFirestore();
                    const itemsUsed = {
                        user: { src: selectedUser.src }, 
                        upper: selectedItems.upper ? { src: selectedItems.upper.src } : null,
                        lower: selectedItems.lower ? { src: selectedItems.lower.src } : null,
                        accessory: selectedItems.accessory ? { src: selectedItems.accessory.src } : null,
                    };
                    await window.Firebase.addDoc(window.Firebase.collection(db, 'users', user.uid, 'looks'), { src: generatedResult, items: itemsUsed, createdAt: window.Firebase.serverTimestamp() });
                    alert("å·²ä¿å­˜ï¼");
                } catch (err) { alert("ä¿å­˜å¤±æ•—"); }
            };

            const handleDelete = async (id, type) => {
                if (isFirebaseReady && user) {
                    const db = window.Firebase.getFirestore();
                    let collectionName = type === 'cloth' ? 'clothes' : (type === 'user' ? 'models' : 'looks');
                    await window.Firebase.deleteDoc(window.Firebase.doc(db, 'users', user.uid, collectionName, id));
                } else {
                    if (type === 'cloth') setClothes(clothes.filter(c => c.id !== id));
                    else if (type === 'user') setUsers(users.filter(u => u.id !== id));
                    else setLooks(looks.filter(l => l.id !== id));
                }
                if (type === 'cloth') { const n = { ...selectedItems }; Object.keys(n).forEach(k => { if (n[k]?.id === id) n[k] = null; }); setSelectedItems(n); }
                else if (type === 'user' && selectedUser?.id === id) setSelectedUser(null);
            };

            const handleGenerateClick = async () => {
                if (!selectedUser) return;
                setIsGenerating(true); setGeneratedResult(null); setErrorMsg('');
                try {
                    const result = await generateTryOnImage(selectedUser.src, selectedItems, API_KEY);
                    setGeneratedResult(result);
                } catch (err) { setErrorMsg(err.message); } finally { setIsGenerating(false); }
            };
            
            const handleDownload = (url, name) => { const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const getCategoryLabel = (cat) => { switch(cat) { case 'upper': return { text: 'ä¸Šèº«', icon: <Icons.Shirt /> }; case 'lower': return { text: 'ä¸‹èº«', icon: <Icons.Grid /> }; case 'accessory': return { text: 'é…ä»¶', icon: <Icons.Watch /> }; default: return { text: 'å…¶ä»–', icon: <Icons.Shirt /> }; }};
            const handleImageError = (e) => { e.target.onerror = null; e.target.src = "https://placehold.co/400x600/e2e8f0/94a3b8?text=Image+Error"; };

            if (isLocked) {
                return <LockScreen onUnlock={() => setIsLocked(false)} isFirebaseReady={isFirebaseReady} />;
            }

            return (
                <div className="flex flex-col h-screen bg-gray-50 overflow-hidden">
                    <header className="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-gradient-to-tr from-purple-600 to-pink-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">V</div>
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600">Virtual Wardrobe</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="text-xs text-gray-400 hidden md:flex items-center gap-1">{isFirebaseReady ? (isSyncing ? "åŒæ­¥ä¸­..." : <><span className="text-green-500">â—</span> é›²ç«¯é€£ç·š</>) : <span className="text-orange-400">æœ¬åœ°æ¨¡å¼</span>}</div>
                            <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><div className="w-5 h-5 text-gray-500"><Icons.Settings /></div></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-y-auto p-4 md:p-6 max-w-5xl mx-auto w-full pb-24 z-0">
                        <div className="flex bg-white rounded-xl p-1 shadow-sm mb-6 sticky top-0 z-40 ring-1 ring-gray-100">
                            {[{ id: 'wardrobe', icon: <Icons.Grid />, label: 'è¡£æ«¥' }, { id: 'user', icon: <Icons.User />, label: 'æ¨¡ç‰¹å…’' }, { id: 'studio', icon: <Icons.Sparkles />, label: 'è©¦ç©¿' }, { id: 'lookbook', icon: <Icons.BookHeart />, label: 'æ—¥èªŒ' }].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-3 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 ${activeTab === tab.id ? 'bg-purple-100 text-purple-700' : 'text-gray-500 hover:bg-gray-50'}`}><div className="w-5 h-5">{tab.icon}</div> <span className="hidden md:inline">{tab.label}</span></button>
                            ))}
                        </div>
                        
                        {activeTab === 'wardrobe' && (
                            <div className="animate-fade-in">
                                <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                                    <div className="flex bg-gray-100 rounded-lg p-1 overflow-x-auto max-w-full">
                                        {['upper', 'lower', 'accessory'].map(type => (
                                            <button key={type} onClick={() => setUploadCategory(type)} className={`px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap ${uploadCategory === type ? 'bg-white shadow-sm text-purple-600' : 'text-gray-500'}`}>{getCategoryLabel(type).text}</button>
                                        ))}
                                    </div>
                                    <button onClick={() => fileInputRefCloth.current.click()} className="flex items-center gap-2 px-6 py-2 bg-slate-900 text-white rounded-full text-sm hover:bg-slate-800 whitespace-nowrap"><div className="w-4 h-4"><Icons.Upload /></div> ä¸Šå‚³è¡£æœ</button>
                                    <input type="file" ref={fileInputRefCloth} className="hidden" accept="image/*" onChange={(e) => handleUpload(e, 'cloth')} />
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pb-10">
                                    {clothes.map((item) => (
                                        <div key={item.id} className="group relative aspect-square bg-white rounded-2xl overflow-hidden border border-gray-100 shadow-sm"><img src={item.src} onError={handleImageError} className="w-full h-full object-cover" /><div className="absolute top-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded-md">{getCategoryLabel(item.category).text}</div><button onClick={(e) => { e.stopPropagation(); handleDelete(item.id, 'cloth'); }} className="absolute top-2 right-2 bg-white text-red-500 p-1.5 rounded-full opacity-0 group-hover:opacity-100"><div className="w-4 h-4"><Icons.Trash /></div></button></div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'user' && (
                            <div className="animate-fade-in">
                                <div className="flex justify-between items-center mb-6"><h2 className="text-lg font-semibold">æ¨¡ç‰¹å…’ç®¡ç†</h2><button onClick={() => fileInputRefUser.current.click()} className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-full text-sm hover:bg-slate-800"><div className="w-4 h-4"><Icons.Camera /></div> ä¸Šå‚³ç…§ç‰‡</button><input type="file" ref={fileInputRefUser} className="hidden" accept="image/*" onChange={(e) => handleUpload(e, 'user')} /></div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 pb-10">
                                    {users.map((item) => (
                                        <div key={item.id} className="group relative aspect-[3/4] bg-white rounded-2xl overflow-hidden border border-gray-100 shadow-sm"><img src={item.src} onError={handleImageError} className="w-full h-full object-cover" /><button onClick={() => handleDelete(item.id, 'user')} className="absolute top-2 right-2 bg-white text-red-500 p-2 rounded-full opacity-0 group-hover:opacity-100"><div className="w-4 h-4"><Icons.Trash /></div></button></div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'studio' && (
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 animate-fade-in mb-10">
                                <div className="flex flex-col lg:flex-row gap-8 justify-center items-start">
                                    <div className="w-full lg:w-1/3"><h3 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">1. é¸æ“‡æ¨¡ç‰¹å…’</h3><div className="grid grid-cols-3 gap-2">{users.map(u => (<div key={u.id} onClick={() => setSelectedUser(u)} className={`aspect-[3/4] rounded-lg overflow-hidden cursor-pointer border-2 transition-all ${selectedUser?.id === u.id ? 'border-purple-500 ring-2 ring-purple-200' : 'border-transparent opacity-70 hover:opacity-100'}`}><img src={u.src} className="w-full h-full object-cover" /></div>))}</div></div>
                                    <div className="w-full lg:w-2/3"><h3 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">2. é¸æ“‡æœé£¾</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-4">{['upper', 'lower', 'accessory'].map(slot => (<div key={slot} onClick={() => { setCurrentSelectionSlot(slot); setIsSelectorOpen(true); }} className={`h-40 rounded-xl border-2 border-dashed flex flex-col items-center justify-center cursor-pointer transition-all hover:bg-gray-50 ${selectedItems[slot] ? 'border-purple-500 bg-purple-50' : 'border-gray-300'}`}>{selectedItems[slot] ? (<div className="relative w-full h-full p-2"><img src={selectedItems[slot].src} className="w-full h-full object-contain" /><button onClick={(e) => { e.stopPropagation(); setSelectedItems(p => ({...p, [slot]: null})); }} className="absolute top-1 right-1 bg-white text-gray-500 rounded-full p-1 shadow-md hover:text-red-500"><div className="w-3 h-3"><Icons.X /></div></button></div>) : (<><div className="w-8 h-8 text-gray-300 mb-2">{getCategoryLabel(slot).icon}</div><span className="text-sm text-gray-400">é¸æ“‡{getCategoryLabel(slot).text}</span></>)}</div>))}</div></div>
                                </div>
                                <div className="mt-8 flex justify-center"><button disabled={!selectedUser || isGenerating} onClick={handleGenerateClick} className={`px-10 py-4 rounded-full font-bold text-lg shadow-xl w-full md:w-auto flex items-center justify-center gap-2 transition-transform active:scale-95 ${!selectedUser ? 'bg-gray-200 text-gray-400' : 'bg-gradient-to-r from-purple-600 to-pink-500 text-white hover:shadow-purple-500/30'}`}>{isGenerating ? <><div className="w-5 h-5"><Icons.Loader /></div> è™•ç†ä¸­...</> : <><div className="w-5 h-5"><Icons.Sparkles /></div> ç”Ÿæˆè©¦ç©¿ç…§</>}</button></div>
                                {(generatedResult || errorMsg) && (<div className="mt-8 pt-8 border-t border-gray-100 flex flex-col items-center animate-slide-up">{errorMsg ? <div className="p-4 bg-red-50 text-red-600 rounded-xl text-center border border-red-100">{errorMsg}</div> : <div className="flex flex-col items-center gap-4 w-full"><h3 className="font-bold text-gray-700">ç”Ÿæˆçµæœ</h3><img src={generatedResult} className="rounded-xl shadow-2xl w-full max-w-sm" /><div className="flex gap-3"><button onClick={() => handleDownload(generatedResult, `tryon-${Date.now()}.jpg`)} className="px-6 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm font-bold flex items-center gap-2 transition-colors"><div className="w-4 h-4"><Icons.Download /></div> ä¸‹è¼‰</button><button onClick={handleSaveLook} className="px-6 py-2 bg-pink-100 hover:bg-pink-200 text-pink-700 rounded-full text-sm font-bold flex items-center gap-2 transition-colors"><div className="w-4 h-4"><Icons.SaveHeart /></div> ä¿å­˜åˆ°æ—¥èªŒ</button></div></div>}</div>)}
                            </div>
                        )}
                        
                        {activeTab === 'lookbook' && (
                            <div className="animate-fade-in">
                                {looks.length === 0 ? <div className="text-center py-20 text-gray-400 bg-white rounded-2xl border-2 border-dashed border-gray-200"><div className="w-16 h-16 mx-auto mb-4 opacity-20"><Icons.BookHeart /></div><p>é‚„æ²’æœ‰ä¿å­˜çš„ç©¿æ­</p></div> : <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">{looks.map((look) => (<div key={look.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col"><div className="relative aspect-[3/4] bg-gray-50"><img src={look.src} className="w-full h-full object-cover" /><button onClick={() => handleDownload(look.src, `look-${look.id}.jpg`)} className="absolute bottom-2 right-2 bg-white/90 p-2 rounded-full shadow-sm hover:bg-white text-gray-700"><div className="w-4 h-4"><Icons.Download /></div></button></div><div className="p-4 flex-1 flex flex-col justify-between"><div><h4 className="font-bold text-sm text-gray-600 mb-3">æ­é…å–®å“</h4><div className="flex gap-2">{look.items?.upper && <img src={look.items.upper.src} className="w-10 h-10 rounded-md border border-gray-200 object-cover bg-white" title="ä¸Šèº«" />}{look.items?.lower && <img src={look.items.lower.src} className="w-10 h-10 rounded-md border border-gray-200 object-cover bg-white" title="ä¸‹èº«" />}{look.items?.accessory && <img src={look.items.accessory.src} className="w-10 h-10 rounded-md border border-gray-200 object-cover bg-white" title="é…ä»¶" />}</div></div><div className="mt-4 pt-3 border-t border-gray-50 flex justify-between items-center"><span className="text-xs text-gray-400">{look.createdAt ? new Date(look.createdAt.seconds * 1000).toLocaleDateString() : 'å‰›å‰›'}</span><button onClick={() => handleDelete(look.id, 'look')} className="text-red-400 hover:text-red-600 text-xs flex items-center gap-1"><div className="w-3 h-3"><Icons.Trash /></div> åˆªé™¤</button></div></div></div>))}</div>}
                            </div>
                        )}

                        {isSelectorOpen && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setIsSelectorOpen(false)}>
                                <div className="bg-white w-full md:w-[600px] h-[70vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden m-4" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b flex justify-between items-center bg-gray-50"><h3 className="font-bold">é¸æ“‡{getCategoryLabel(currentSelectionSlot).text}</h3><button onClick={() => setIsSelectorOpen(false)}><div className="w-6 h-6"><Icons.X /></div></button></div>
                                    <div className="flex-1 overflow-y-auto p-4 bg-white">{clothes.filter(c => c.category === currentSelectionSlot).length === 0 ? <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-2"><p>æ²’æœ‰è¡£æœ</p><button onClick={() => { setIsSelectorOpen(false); setActiveTab('wardrobe'); setUploadCategory(currentSelectionSlot); }} className="text-purple-600 font-bold">å»ä¸Šå‚³</button></div> : <div className="grid grid-cols-3 gap-3">{clothes.filter(c => c.category === currentSelectionSlot).map(item => (<div key={item.id} onClick={() => { setSelectedItems(p => ({...p, [currentSelectionSlot]: item})); setIsSelectorOpen(false); }} className="cursor-pointer aspect-square bg-white rounded-xl border-2 border-transparent hover:border-purple-500 overflow-hidden shadow-sm"><img src={item.src} className="w-full h-full object-cover" /></div>))}</div>}</div>
                                </div>
                            </div>
                        )}

                        {showSettings && <SettingsModal onClose={() => setShowSettings(false)} user={user} isFirebaseReady={isFirebaseReady} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StyleMate />);
    </script>
</body>
</html>
