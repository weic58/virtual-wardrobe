<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- API å®‰å…¨æ€§è¨­å®š -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    
    <!-- ç¶²é åœ–ç¤º -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§¥</text></svg>">
    
    <title>Virtual Wardrobe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, signInAnonymously, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc, onSnapshot, query, orderBy, serverTimestamp, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.Firebase = { 
            initializeApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
            signInWithPopup, signInAnonymously, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile,
            getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc, onSnapshot, query, orderBy, serverTimestamp, arrayUnion, arrayRemove, increment 
        };
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans h-[100dvh] overflow-hidden">
    
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        // ==========================================
        //  è¨­å®šå€
        // ==========================================

        const YOUR_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDO31PRKXec6po5prR0CquPxiqRfubS9KQ",
        authDomain: "virtual-wardrobe-photos.firebaseapp.com",
        projectId: "virtual-wardrobe-photos",
        storageBucket: "virtual-wardrobe-photos.firebasestorage.app",
        messagingSenderId: "96273892644",
        appId: "1:96273892644:web:3008f7f604c57669f35fb1"
        };

        const CLOTH_CATEGORIES = {
            upper: { label: 'ä¸Šèº«', types: ['é•·è¢–', 'çŸ­è¢–', 'Tæ¤', 'è¥¯è¡«', 'èƒŒå¿ƒ', 'æ¯›è¡£', 'å…¶ä»–'] },
            outerwear: { label: 'å¤–å¥—', types: ['å¤¾å…‹', 'å¤§è¡£', 'è¥¿è£å¤–å¥—', 'é‡ç¹”è¡«', 'é¢¨è¡£', 'å…¶ä»–'] },
            lower: { label: 'ä¸‹èº«', types: ['é•·è¤²', 'çŸ­è¤²', 'ç‰›ä»”è¤²', 'ä¼‘é–’è¤²', 'è£™å­', 'å…¶ä»–'] },
            shoes: { label: 'é‹å­', types: ['é‹å‹•é‹', 'çš®é‹', 'æ¶¼é‹', 'é´å­', 'é«˜è·Ÿé‹', 'å…¶ä»–'] },
            accessory: { label: 'é…ä»¶', types: ['é …éŠ', 'æ‰‹éŠ', 'çš®å¸¶', 'é ˜å¸¶', 'å¸½å­', 'åŒ…åŒ…', 'å…¶ä»–'] },
            hairstyle: { label: 'é«®å‹', types: ['çŸ­é«®', 'é•·é«®', 'æ²é«®', 'é¦¬å°¾', 'å…¶ä»–'] }
        };

        const DEFAULT_BRANDS = ['Uniqlo', 'GU', 'MUJI', '50%', 'Nike', 'Adidas', 'Zara', 'H&M'];

        // ==========================================

        const { useState, useRef, useEffect } = React;

        // --- Utils ---
        const compressImage = (base64Str, maxWidth = 800, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        };

        // --- Icons ---
        const Icons = {
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="-2 -2 28 28" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Jacket: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="-2 -2 28 28" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22v-5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v5"/><path d="M4 15V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v11"/><path d="M9 15v7"/><path d="M15 15v7"/></svg>,
            Shirt: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></svg>,
            Grid: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Watch: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="6"/><polyline points="12 10 12 12 13 13"/><path d="m16.13 7.66-.81-4.05a2 2 0 0 0-2.53-1.46l-4.24.85a2 2 0 0 0-1.46 2.53l.81 4.05"/><path d="m7.88 16.34.81 4.05a2 2 0 0 0 2.53 1.46l4.24-.85a2 2 0 0 0 1.46-2.53l-.81-4.05"/></svg>,
            Loader: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            CloudCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" opacity="0.1"/><path d="m9 12 2 2 4-4"/></svg>,
            BookHeart: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M12 8c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2z"/><path d="M8 8h.01"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            SaveHeart: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Google: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>,
            Layer: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Scissors: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" x2="8.12" y1="4" y2="15.88"/><line x1="14.47" x2="20" y1="14.48" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Body: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="5" r="1"/><path d="m9 20 3-6 3 6"/><path d="m6 8 6 2 6-2"/><path d="M12 10v4"/></svg>,
            Tag: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Shoes: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 20h20"/><path d="M5 20v-5.26a3 3 0 0 1 .88-2.12l5.12-5.12a2 2 0 0 1 2.83 0l5.12 5.12a3 3 0 0 1 .88 2.12V20"/><path d="M13 14h.01"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>,
            Coin: () => <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>
        };

        const generateTryOnImage = async (userImage, selectedItems, apiKey, mode = 'studio', customPrompt = '', focusMode = 'full', activeSlots = [], onDebugPrompt) => {
            if (!apiKey) throw new Error("è«‹åœ¨è¨­å®šä¸­è¼¸å…¥ API Key");
            
            let promptText = "é€™æ˜¯ä¸€é …è™›æ“¬è©¦ç©¿ä»»å‹™ã€‚ç¬¬ä¸€å¼µåœ–ç‰‡æ˜¯'ä½¿ç”¨è€…' (æ¨¡ç‰¹å…’)ã€‚";
            
            const imageParts = [];
            // ç¬¬ä¸€æ¬¡æ”¾å…¥ä½¿ç”¨è€… (èº«é«”åƒè€ƒ)
            imageParts.push({ inlineData: { mimeType: "image/jpeg", data: userImage.split(',')[1] } });
            
            let clothIndex = 2;

            activeSlots.forEach(slot => {
                const item = selectedItems[slot.id];
                if (item) {
                    let label = "è¡£ç‰©é…ä»¶"; 
                    if (slot.category === 'hairstyle') label = "é«®å‹åƒè€ƒ";
                    
                    promptText += ` ç¬¬ ${clothIndex} å¼µåœ–ç‰‡æ˜¯'${label}'ã€‚`;
                    imageParts.push({ inlineData: { mimeType: "image/jpeg", data: item.src.split(',')[1] } });
                    clothIndex++;
                }
            });

            // è‡‰éƒ¨é‡æ³¨ç­–ç•¥ (ä¿æŒé€™å€‹ä»¥ç¶­æŒè‡‰éƒ¨ç©©å®š)
            promptText += ` ç¬¬ ${clothIndex} å¼µåœ–ç‰‡æ˜¯'è‡‰éƒ¨äº”å®˜ç‰¹å¯«åƒè€ƒ'ã€‚`;
            imageParts.push({ inlineData: { mimeType: "image/jpeg", data: userImage.split(',')[1] } });
            
            promptText += " è«‹ç”Ÿæˆä¸€å¼µé«˜å“è³ªã€å¯«å¯¦çš„ç…§ç‰‡ï¼Œé¡¯ç¤º'ä½¿ç”¨è€…'ç©¿è‘—ä¸Šè¿°é¸å®šçš„è¡£ç‰©/é…ä»¶ã€‚";
            
            // [æ ¸å¿ƒæŒ‡ä»¤å€] - ä¸è«–ä»€éº¼æ¨¡å¼éƒ½è¦éµå®ˆçš„ç‰©ç†è¦å‰‡
            promptText += " [çµ•å°è¦å‰‡]ï¼š";
            promptText += " 1. ã€è‡‰éƒ¨é–å®šã€‘ï¼šè‡‰éƒ¨äº”å®˜å¿…é ˆèˆ‡ç¬¬ 1 å¼µåŠæœ€å¾Œä¸€å¼µåœ–ç‰‡å®Œå…¨ä¸€è‡´ï¼Œä¸å¯æ”¹è®Šé•·ç›¸ã€‚";
            
            if (focusMode === 'face') {
                promptText += " 2. ã€ç‰¹å¯«æ¨¡å¼ã€‘ï¼šè«‹ç”ŸæˆåŠèº«æˆ–é ­åƒç‰¹å¯«ï¼Œé‡é»åœ¨å±•ç¤ºè‡‰éƒ¨èˆ‡ä¸ŠåŠèº«æ­é…ã€‚";
            } else {
                promptText += " 2. ã€å…¨èº«æ¨¡å¼ã€‘ï¼šè«‹ç›¡é‡å±•ç¤ºå…¨èº«æˆ–ä¸ƒåˆ†èº«ç©¿æ­ã€‚";
            }

            // [é¢¨æ ¼/å ´æ™¯åˆ†æ”¯] - æ ¹æ“šæ‚¨çš„è¦æ±‚å¾¹åº•åˆ†æµ
            if (mode === 'custom') {
                // === è‡ªè¨‚æ¨¡å¼ ===
                // å®Œå…¨è¦†è“‹ï¼šä¸åŠ ä»»ä½•é è¨­èƒŒæ™¯ã€è¡¨æƒ…ã€å§¿å‹¢æŒ‡ä»¤ï¼Œå®Œå…¨è½å¾ customPrompt
                if (customPrompt) {
                    promptText += ` 3. ã€è‡ªè¨‚æŒ‡ä»¤ã€‘ï¼š${customPrompt}`;
                } else {
                    promptText += ` 3. èƒŒæ™¯èˆ‡é¢¨æ ¼ï¼šè«‹ä¿æŒè‡ªç„¶å¯«å¯¦ã€‚`; // è‹¥ä½¿ç”¨è€…é¸è‡ªè¨‚å»æ²’æ‰“å­—ï¼Œçµ¦å€‹æœ€åŸºæœ¬çš„å…œåº•
                }

            } else if (mode === 'minimal') {
                // === æœ€å°è®ŠåŒ–æ¨¡å¼ ===
                // é‡é»æ˜¯ã€Œä¸å‹•èƒŒæ™¯ã€
                promptText += " 3. ã€æœ€å°è®ŠåŒ–ã€‘ï¼šè«‹åš´æ ¼ä¿ç•™åŸåœ–(ç¬¬1å¼µ)çš„èƒŒæ™¯ç’°å¢ƒã€å…‰å½±æ°›åœèˆ‡èº«é«”å§¿å‹¢ï¼Œåƒ…æ›¿æ›è¡£ç‰©ã€‚";
                promptText += " 4. è¡¨æƒ…ï¼šä¿æŒåŸåœ–è¡¨æƒ…ã€‚";

            } else {
                // === æ£šæ‹æ¨¡å¼ (Studio) - é è¨­ ===
                // é‡é»æ˜¯ã€Œç™½èƒŒæ™¯ã€+ã€Œå¥½çœ‹çš„æ¨¡ç‰¹åœ–ã€
                promptText += " 3. ã€æ£šæ‹é¢¨æ ¼ã€‘ï¼šèƒŒæ™¯å¿…é ˆæ›¿æ›ç‚º'ç´”ç™½è‰²æ”å½±æ£šèƒŒæ™¯' (Pure White Studio Background)ã€‚";
                promptText += " 4. å…‰å½±ï¼šä½¿ç”¨å°ˆæ¥­æ”å½±æ£šæ‰“å…‰ (Studio Lighting)ã€‚";
                promptText += " 5. å§¿å‹¢ï¼šæ¨¡ç‰¹å…’è«‹å‘ˆç¾'æ­£é¢å…¨èº«'ã€‚";
                promptText += " 6. è¡¨æƒ…ï¼šé¢å¸¶æŸ”å’Œå¾®ç¬‘ä½†ä¸éœ²é½’ã€‚";
            }

            if (onDebugPrompt) {
                onDebugPrompt(promptText);
            }

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }, ...imageParts] }],
                            generationConfig: { responseModalities: ["IMAGE"], temperature: 0.4 },
                            safetySettings: [
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                            ]
                        }),
                    }
                );
                
                const data = await response.json();
                
                if (data.error) throw new Error(`API Error: ${data.error.message}`);
                const candidate = data.candidates?.[0];
                if (candidate?.finishReason === 'SAFETY') throw new Error("âš ï¸ åœ–ç‰‡è¢«å®‰å…¨ç³»çµ±æ””æˆªï¼šè«‹æ›´æ›ç…§ç‰‡ã€‚");
                if (candidate?.content?.parts) {
                    const imagePart = candidate.content.parts.find(p => p.inlineData);
                    if (imagePart) return `data:image/jpeg;base64,${imagePart.inlineData.data}`;
                }
                throw new Error("ç”Ÿæˆå¤±æ•—ï¼šæ¨¡å‹æ‹’çµ•ç”¢ç”Ÿåœ–ç‰‡");
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        // --- Settings Modal ---
        const SettingsModal = ({ onClose, user, isFirebaseReady, apiKey, onSaveApiKey, genStats, onRedeem, userBrands = [], onDeleteBrand, userTags = [], onDeleteTag }) => {
            const [inputKey, setInputKey] = useState(apiKey || '');
            const [redeemCode, setRedeemCode] = useState('');
            const [msg, setMsg] = useState('');
            const [redeemMsg, setRedeemMsg] = useState('');

            const handleLogout = async () => {
                if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                    await window.Firebase.signOut(window.Firebase.getAuth());
                    window.location.reload();
                }
            };

            const handleSaveKey = () => {
                onSaveApiKey(inputKey);
                setMsg('âœ… å„²å­˜æˆåŠŸ');
                setTimeout(() => setMsg(''), 2000);
            };

            const handleRedeemClick = async () => {
                if (!redeemCode.trim()) return;
                const success = await onRedeem(redeemCode);
                if (success) {
                    setRedeemMsg('âœ… æˆåŠŸå¢åŠ  5 æ¬¡é¡åº¦ï¼');
                    setRedeemCode('');
                } else {
                    setRedeemMsg('âŒ ä»£ç¢¼ç„¡æ•ˆ');
                }
                setTimeout(() => setRedeemMsg(''), 3000);
            };

            const getAvatarText = () => {
                if (user.displayName) return user.displayName[0].toUpperCase();
                if (user.email) return user.email[0].toUpperCase();
                return "A";
            };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col m-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-6 border-b">
                            <h3 className="font-bold text-lg flex items-center gap-2"><div className="w-5 h-5 text-slate-500"><Icons.Settings /></div> è¨­å®š</h3>
                            <button onClick={onClose}><div className="w-5 h-5"><Icons.X /></div></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto space-y-6">
                            {user && (
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold text-lg overflow-hidden">
                                            {user.photoURL ? <img src={user.photoURL} className="w-full h-full object-cover" /> : getAvatarText()}
                                        </div>
                                        <div className="overflow-hidden">
                                            <p className="font-bold text-gray-800 truncate">{user.displayName || (user.isAnonymous ? "è¨ªå®¢" : "ä½¿ç”¨è€…")}</p>
                                            <p className="text-xs text-gray-500 truncate">{user.email || "æœªç¶å®š Email"}</p>
                                            <p className="text-[10px] text-gray-400 font-mono truncate">UID: {user.uid}</p>
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-500 flex justify-between items-center mt-2 bg-white p-2 rounded border">
                                        <span>é¡åº¦ä½¿ç”¨:</span>
                                        <span className={`font-bold ${genStats.count >= genStats.limit ? 'text-red-500' : 'text-green-600'}`}>
                                            {genStats.count} / {genStats.limit}
                                        </span>
                                    </div>
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-gray-500 mb-1">è¼¸å…¥ä»£ç¢¼åŠ å€¼</label>
                                <div className="flex gap-2">
                                    <input type="text" value={redeemCode} onChange={(e) => setRedeemCode(e.target.value)} placeholder="è¼¸å…¥ä»£ç¢¼" className="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm" />
                                    <button onClick={handleRedeemClick} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700">å…Œæ›</button>
                                </div>
                                {redeemMsg && <p className="text-xs mt-1 text-center font-bold">{redeemMsg}</p>}
                                <p className="text-[10px] text-gray-400 mt-1">è¼¸å…¥ä»£ç¢¼å¯å¢åŠ  5 æ¬¡ç”Ÿæˆé¡åº¦ã€‚</p>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-500 mb-1">Google Gemini API é‡‘é‘°</label>
                                <div className="flex gap-2">
                                    <input type="password" value={inputKey} onChange={(e) => setInputKey(e.target.value)} placeholder="è²¼ä¸Š API Key" className="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-mono" />
                                    <button onClick={handleSaveKey} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700">å„²å­˜</button>
                                </div>
                                {msg && <p className="text-xs mt-1 text-green-600">{msg}</p>}
                            </div>

                            {userBrands && userBrands.length > 0 && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-500 mb-1">ç®¡ç†è‡ªè¨‚å“ç‰Œ</label>
                                    <div className="flex flex-wrap gap-2">
                                        {userBrands.map(brand => (
                                            <div key={brand} className="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded flex items-center gap-1 border border-blue-100">
                                                {brand}
                                                <button onClick={() => onDeleteBrand(brand)} className="hover:text-red-500 font-bold">Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {userTags && userTags.length > 0 && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-500 mb-1">ç®¡ç†è‡ªè¨‚æ¨™ç±¤</label>
                                    <div className="flex flex-wrap gap-2">
                                        {userTags.map(tag => (
                                            <div key={tag} className="bg-purple-50 text-purple-700 text-xs px-2 py-1 rounded flex items-center gap-1 border border-purple-100">
                                                #{tag}
                                                <button onClick={() => onDeleteTag(tag)} className="hover:text-red-500 font-bold">Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <button onClick={handleLogout} className="w-full py-3 bg-red-50 text-red-600 rounded-xl text-sm font-bold hover:bg-red-100 flex items-center justify-center gap-2 transition-colors"><div className="w-4 h-4"><Icons.LogOut /></div> ç™»å‡ºå¸³è™Ÿ</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Modified UploadEditorModal ---
        const UploadEditorModal = ({ isOpen, onClose, file, onConfirm, isEdit, initialData, userTags, onAddTag, onDeleteTag, userBrands, onAddBrand, defaultCategory }) => {
            if (!isOpen) return null;
            const [name, setName] = useState('');
            const [category, setCategory] = useState('upper');
            const [subCategory, setSubCategory] = useState('é•·è¢–');
            const [brand, setBrand] = useState('Uniqlo');
            const [customBrand, setCustomBrand] = useState('');
            const [selectedTags, setSelectedTags] = useState([]); 
            const [newTagInput, setNewTagInput] = useState('');
            const [previewUrl, setPreviewUrl] = useState('');

            const availableBrands = [...DEFAULT_BRANDS, ...(userBrands || []), 'è‡ªè¨‚'];

            // æ ¸å¿ƒåŠŸèƒ½ï¼šç•¶é–‹å•Ÿä¸Šå‚³æ™‚ï¼Œè‡ªå‹•æ ¹æ“šç›®å‰é ç±¤ (defaultCategory) è¨­å®šåˆ†é¡
            useEffect(() => {
                if (isOpen && !isEdit && defaultCategory && defaultCategory !== 'all') {
                    if (CLOTH_CATEGORIES[defaultCategory]) {
                        setCategory(defaultCategory);
                        // è‡ªå‹•åˆ‡æ›è©²åˆ†é¡çš„ç¬¬ä¸€å€‹å­é …ç›® (types)
                        setSubCategory(CLOTH_CATEGORIES[defaultCategory].types[0] || 'å…¶ä»–');
                    }
                }
            }, [isOpen, defaultCategory, isEdit]);

            useEffect(() => {
                if (isEdit && initialData) {
                    setName(initialData.name || '');
                    setCategory(initialData.category || 'upper');
                    setSubCategory(initialData.subCategory || (CLOTH_CATEGORIES[initialData.category || 'upper']?.types[0] || 'å…¶ä»–'));
                    const b = initialData.brand || 'Uniqlo';
                    if (availableBrands.includes(b) && b !== 'è‡ªè¨‚') { setBrand(b); } 
                    else { setBrand('è‡ªè¨‚'); setCustomBrand(b); }
                    setSelectedTags(initialData.tags || []);
                    setPreviewUrl(initialData.src);
                } else if (file) {
                    const defaultName = file.name.replace(/\.[^/.]+$/, "");
                    setName(defaultName);
                    const reader = new FileReader();
                    reader.onloadend = () => setPreviewUrl(reader.result);
                    reader.readAsDataURL(file);
                }
            }, [file, isEdit, initialData, userBrands]);

            useEffect(() => {
                // ç•¶åˆ‡æ›åˆ†é¡æ™‚ï¼Œè‡ªå‹•é‡è¨­å­åˆ†é¡ç‚ºè©²åˆ†é¡çš„ç¬¬ä¸€é …ï¼Œé¿å…å­åˆ†é¡èˆ‡ä¸»åˆ†é¡ä¸åŒ¹é…
                if (!isEdit && category) { 
                    setSubCategory(CLOTH_CATEGORIES[category]?.types[0] || 'å…¶ä»–'); 
                }
            }, [category]);

            const handleConfirm = () => {
                let finalBrand = brand;
                if (brand === 'è‡ªè¨‚') {
                    finalBrand = customBrand.trim();
                    if (finalBrand && onAddBrand) onAddBrand(finalBrand);
                }
                onConfirm({ name, category, subCategory, brand: finalBrand, tags: selectedTags });
                onClose();
            };

            const toggleTag = (tag) => {
                if (selectedTags.includes(tag)) setSelectedTags(selectedTags.filter(t => t !== tag));
                else setSelectedTags([...selectedTags, tag]);
            };

            const handleAddNewTag = () => {
                if (newTagInput.trim()) {
                    onAddTag(newTagInput.trim());
                    if (!selectedTags.includes(newTagInput.trim())) setSelectedTags([...selectedTags, newTagInput.trim()]);
                    setNewTagInput('');
                }
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50"><h3 className="font-bold text-lg">{isEdit ? 'ç·¨è¼¯å–®å“' : 'æ–°å¢å–®å“'}</h3><button onClick={onClose}><div className="w-5 h-5 text-gray-500"><Icons.X /></div></button></div>
                        <div className="p-4 overflow-y-auto flex-1">
                            <div className="flex justify-center mb-4 bg-gray-100 rounded-lg p-2">{previewUrl && <img src={previewUrl} className="h-40 object-contain rounded-md" />}</div>
                            <div className="space-y-4">
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">åç¨±</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border rounded-lg text-sm focus:ring-1 focus:ring-purple-500 outline-none" /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡</label><select value={category} onChange={e => setCategory(e.target.value)} className="w-full p-2 border rounded-lg text-sm bg-white">{Object.entries(CLOTH_CATEGORIES).map(([key, val]) => (<option key={key} value={key}>{val.label}</option>))}</select></div>
                                    <div><label className="block text-xs font-bold text-gray-500 mb-1">ç¨®é¡</label><select value={subCategory} onChange={e => setSubCategory(e.target.value)} className="w-full p-2 border rounded-lg text-sm bg-white">{CLOTH_CATEGORIES[category]?.types.map(t => (<option key={t} value={t}>{t}</option>))}</select></div>
                                </div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">å“ç‰Œ</label><div className="flex gap-2"><select value={brand} onChange={e => setBrand(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm bg-white">{availableBrands.map(b => <option key={b} value={b}>{b}</option>)}</select>{brand === 'è‡ªè¨‚' && (<input type="text" placeholder="è¼¸å…¥å“ç‰Œ" value={customBrand} onChange={e => setCustomBrand(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm outline-none" />)}</div></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">æ¨™ç±¤ (é»æ“Šé¸å–)</label><div className="flex flex-wrap gap-2 mb-2">{userTags.map(tag => (<div key={tag} className={`px-2 py-1 rounded-md text-xs cursor-pointer flex items-center gap-1 border ${selectedTags.includes(tag) ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-white text-gray-600 border-gray-200'}`} onClick={() => toggleTag(tag)}><span>{tag}</span><span onClick={(e) => { e.stopPropagation(); onDeleteTag(tag); }} className="text-gray-400 hover:text-red-500 px-1 font-bold">Ã—</span></div>))}{userTags.length === 0 && <span className="text-xs text-gray-400">å°šç„¡å„²å­˜æ¨™ç±¤</span>}</div><div className="flex gap-2"><input type="text" value={newTagInput} onChange={(e) => setNewTagInput(e.target.value)} placeholder="æ–°å¢æ¨™ç±¤" className="flex-1 p-2 border rounded-lg text-xs outline-none" /><button onClick={handleAddNewTag} className="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold hover:bg-gray-200"><div className="w-3 h-3"><Icons.Plus /></div></button></div></div>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-gray-500 text-sm font-bold hover:bg-gray-200 rounded-lg">å–æ¶ˆ</button><button onClick={handleConfirm} className="px-6 py-2 bg-slate-900 text-white text-sm font-bold rounded-lg hover:bg-slate-700">å„²å­˜</button></div>
                    </div>
                </div>
            );
        };

        // --- Look Details Modal with Rename ---
        const LookDetailsModal = ({ isOpen, onClose, look, lookName, onRename, onRestore }) => {
            if (!isOpen || !look) return null;

            // Handle rename within modal
            const [isEditingName, setIsEditingName] = useState(false);
            const [tempName, setTempName] = useState(lookName);

            const handleNameSave = () => {
                onRename(look.id, tempName);
                setIsEditingName(false);
            };
            
            // Rename individual items in look
            const handleItemRename = (slot, currentName) => {
                const newName = prompt("ç·¨è¼¯å–®å“åç¨±:", currentName);
                if (newName && newName !== currentName && onRename) {
                     if (look.items[slot]) {
                         // This would require a specific handler passed from parent, or logic here.
                     }
                }
            };
            
            const ItemCard = ({ item, label, icon }) => {
                if (!item) return null;
                return (
                    <div className="flex items-center gap-3 p-2 bg-gray-50 rounded-lg border border-gray-100">
                        <div className="w-12 h-12 bg-white rounded-md overflow-hidden flex-shrink-0 border border-gray-200"><img src={item.src} className="w-full h-full object-cover" /></div>
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-start">
                                <p className="text-xs text-purple-600 font-bold flex items-center gap-1"><div className="w-3 h-3">{icon}</div> {label}</p>
                                <button className="text-gray-300 hover:text-purple-600" onClick={() => {
                                    // Basic prompt implementation for item rename
                                }}><div className="w-3 h-3"><Icons.Edit /></div></button>
                            </div>
                            <p className="text-sm font-medium text-gray-800 truncate">{item.name || "æœªå‘½åå–®å“"}</p>
                            {(item.brand || item.subCategory) && <p className="text-[10px] text-gray-500 truncate">{item.brand ? item.brand : ''} {item.brand && item.subCategory ? ' Â· ' : ''}{item.subCategory ? item.subCategory : ''}</p>}
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onClick={onClose}>
                    <div className="bg-white w-full max-w-4xl h-[100dvh] md:h-[80vh] rounded-none md:rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row" onClick={e => e.stopPropagation()}>
                        <div className="w-full md:w-1/2 bg-gray-100 relative flex items-center justify-center h-[40%] md:h-full bg-contain bg-center bg-no-repeat"><img src={look.src} className="w-full h-full object-contain" /><button onClick={onClose} className="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 md:hidden"><div className="w-5 h-5"><Icons.X /></div></button></div>
                        <div className="w-full md:w-1/2 flex flex-col h-[60%] md:h-full bg-white">
                            <div className="p-4 border-b flex justify-between items-center">
                                <div>
                                    <div className="flex items-center gap-2">
                                        {isEditingName ? (
                                            <div className="flex items-center gap-1">
                                                <input type="text" value={tempName} onChange={(e) => setTempName(e.target.value)} className="border rounded px-2 py-1 text-sm font-bold w-32" />
                                                <button onClick={handleNameSave} className="text-green-600 hover:text-green-700 text-xs">OK</button>
                                            </div>
                                        ) : (
                                            <div className="flex items-center gap-2">
                                                <h3 className="font-bold text-lg text-gray-800">{lookName}</h3>
                                                <button onClick={() => setIsEditingName(true)} className="text-gray-400 hover:text-purple-600"><div className="w-4 h-4"><Icons.Edit /></div></button>
                                            </div>
                                        )}
                                    </div>
                                    <p className="text-xs text-gray-500">å»ºç«‹æ–¼: {look.createdAt ? new Date(look.createdAt.seconds * 1000).toLocaleString() : 'æœªçŸ¥æ™‚é–“'}</p>
                                </div>
                                <button onClick={onClose} className="hidden md:block p-2 hover:bg-gray-100 rounded-full"><div className="w-5 h-5 text-gray-500"><Icons.X /></div></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-20 md:pb-4">
                                <div className="space-y-2"><h5 className="text-xs font-bold text-gray-400 uppercase tracking-wider pl-1">ğŸ’‡ é«®å‹</h5>{look.items?.hairstyle ? <ItemCard item={look.items.hairstyle} label="é«®å‹" icon={<Icons.Scissors />} /> : <div className="p-2 text-center text-xs text-gray-300 border border-dashed rounded-lg">ç„¡é«®å‹ç´€éŒ„</div>}</div>
                                <div className="space-y-2 pt-2 border-t border-dashed border-gray-100"><h5 className="text-xs font-bold text-gray-400 uppercase tracking-wider pl-1">ğŸ‘• æœé£¾</h5>{look.items?.upper ? <ItemCard item={look.items.upper} label="ä¸Šèº«" icon={<Icons.Shirt />} /> : <div className="p-2 text-center text-xs text-gray-300 border border-dashed rounded-lg">ç„¡ä¸Šèº«ç´€éŒ„</div>}{look.items?.lower ? <ItemCard item={look.items.lower} label="ä¸‹èº«" icon={<Icons.Grid />} /> : <div className="p-2 text-center text-xs text-gray-300 border border-dashed rounded-lg">ç„¡ä¸‹èº«ç´€éŒ„</div>}{look.items?.shoes ? <ItemCard item={look.items.shoes} label="é‹å­" icon={<Icons.Shoes />} /> : <div className="p-2 text-center text-xs text-gray-300 border border-dashed rounded-lg">ç„¡é‹å­ç´€éŒ„</div>}{look.items?.accessory ? <ItemCard item={look.items.accessory} label="é…ä»¶" icon={<Icons.Watch />} /> : <div className="p-2 text-center text-xs text-gray-300 border border-dashed rounded-lg">ç„¡é…ä»¶ç´€éŒ„</div>}</div>
                            </div>
                            {/* [ä¿®æ”¹] åº•éƒ¨æŒ‰éˆ•å€ï¼šæ–°å¢é‚„åŸæŒ‰éˆ• */}
                            <div className="p-4 border-t bg-gray-50 absolute bottom-0 w-full md:relative flex gap-2">
                                <button onClick={() => onRestore(look)} className="flex-1 py-3 bg-white border border-gray-200 text-purple-700 rounded-xl text-sm font-bold hover:bg-purple-50 flex items-center justify-center gap-2 transition-colors shadow-sm">
                                    <div className="w-4 h-4"><Icons.Sparkles /></div> ä¿®æ”¹/è©¦ç©¿
                                </button>
                                <a href={look.src} download={`look-${look.id}.jpg`} className="flex-1 py-3 bg-slate-900 text-white rounded-xl text-sm font-bold hover:bg-slate-800 flex items-center justify-center gap-2 transition-colors shadow-sm">
                                    <div className="w-4 h-4"><Icons.Download /></div> ä¸‹è¼‰
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ isFirebaseReady }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                if (!isFirebaseReady) { setError("å°šæœªé€£ç·šåˆ° Firebase"); setLoading(false); return; }
                try {
                    const auth = window.Firebase.getAuth();
                    if (isRegister) {
                        const cred = await window.Firebase.createUserWithEmailAndPassword(auth, email, password);
                        await window.Firebase.updateProfile(cred.user, { displayName: name });
                    } else {
                        await window.Firebase.signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/invalid-email') msg = "Email æ ¼å¼éŒ¯èª¤";
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                    if (err.code === 'auth/email-already-in-use') msg = "æ­¤ Email å·²è¢«è¨»å†Š";
                    if (err.code === 'auth/weak-password') msg = "å¯†ç¢¼å¤ªå¼± (è‡³å°‘6ä½)";
                    setError(msg);
                    setLoading(false);
                }
            };

            const handleGoogleLogin = async () => {
                if (!isFirebaseReady) { setError("å°šæœªé€£ç·šåˆ° Firebase"); return; }
                setLoading(true);
                try {
                    const auth = window.Firebase.getAuth();
                    const provider = new window.Firebase.GoogleAuthProvider();
                    await window.Firebase.signInWithPopup(auth, provider);
                } catch (err) { setError(err.message); setLoading(false); }
            };

            const handleAnonymousLogin = async () => {
                if (!isFirebaseReady) { setError("å°šæœªé€£ç·šåˆ° Firebase"); return; }
                setLoading(true);
                try {
                    const auth = window.Firebase.getAuth();
                    await window.Firebase.signInAnonymously(auth);
                } catch (err) { setError(err.message); setLoading(false); }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-white p-4">
                    <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700">
                        <div className="flex justify-center mb-6"><div className="w-16 h-16 bg-gradient-to-tr from-purple-600 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg">{loading ? <div className="animate-spin"><Icons.Loader /></div> : <Icons.User />}</div></div>
                        <h2 className="text-2xl font-bold text-center mb-2">è™›æ“¬è©¦ç©¿è¡£æ«¥</h2>
                        <p className="text-slate-400 text-center mb-6 text-sm">{isFirebaseReady ? (isRegister ? "è¨»å†Šæ–°å¸³è™Ÿ" : "ç™»å…¥æ‚¨çš„è¡£æ«¥") : <span className="text-orange-400">ç­‰å¾… Firebase é€£ç·š...</span>}</p>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {isRegister && <input type="text" placeholder="æ‚¨çš„æš±ç¨±" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-slate-900 border border-slate-600 focus:border-purple-500 outline-none" required />}
                            <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-slate-900 border border-slate-600 focus:border-purple-500 outline-none" required />
                            <input type="password" placeholder="å¯†ç¢¼" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-slate-900 border border-slate-600 focus:border-purple-500 outline-none" required />
                            {error && <p className="text-red-400 text-sm text-center bg-red-900/20 p-2 rounded-lg">{error}</p>}
                            <button type="submit" disabled={loading} className={`w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 font-bold hover:shadow-lg transition-all ${loading ? 'opacity-50' : ''}`}>{loading ? 'è™•ç†ä¸­...' : (isRegister ? 'è¨»å†Š' : 'ç™»å…¥')}</button>
                        </form>
                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-600"></div></div><div className="relative flex justify-center text-xs"><span className="px-2 bg-slate-800 text-slate-400">æˆ–ä½¿ç”¨</span></div></div>
                        <button type="button" onClick={handleGoogleLogin} disabled={loading} className="w-full py-3 rounded-xl bg-white text-slate-700 font-bold hover:bg-gray-100 transition-all flex items-center justify-center gap-2"><div className="w-5 h-5"><Icons.Google /></div> Google ç™»å…¥</button>
                        <button type="button" onClick={handleAnonymousLogin} disabled={loading} className="w-full mt-3 py-3 rounded-xl bg-slate-700 text-slate-200 font-bold hover:bg-slate-600 transition-all flex items-center justify-center gap-2"><div className="w-5 h-5"><Icons.User /></div> è¨ªå®¢ç™»å…¥</button>
                        <div className="mt-6 text-center text-sm text-slate-400">{isRegister ? "å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ" : "é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ"} <button onClick={() => { setIsRegister(!isRegister); setError(''); }} className="ml-2 text-purple-400 hover:text-purple-300 font-bold underline">{isRegister ? "ç›´æ¥ç™»å…¥" : "ç«‹å³è¨»å†Š"}</button></div>
                    </div>
                </div>
            );
        };

        const VirtualWardrobe = () => {
            const [showSettings, setShowSettings] = useState(false);
            const [activeTab, setActiveTab] = useState('wardrobe');
            const [clothes, setClothes] = useState([]);
            const [users, setUsers] = useState([]);
            const [looks, setLooks] = useState([]);
            const [userTags, setUserTags] = useState([]); 
            const [userBrands, setUserBrands] = useState([]); 
            const [genStats, setGenStats] = useState({ count: 0, limit: 1 }); 
            const [user, setAuthUser] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [globalApiKey, setGlobalApiKey] = useState(''); 
            
            // --- æ ¸å¿ƒä¿®æ”¹ï¼šå°‡ Slots è½‰ç‚º State ä»¥æ”¯æ´å‹•æ…‹æ–°å¢ ---
            const [tryOnSlots, setTryOnSlots] = useState([
                { id: 'hairstyle', category: 'hairstyle', label: 'é«®å‹' },
                { id: 'upper', category: 'upper', label: 'ä¸Šèº«' },
                { id: 'outerwear', category: 'outerwear', label: 'å¤–å¥—' },
                { id: 'lower', category: 'lower', label: 'ä¸‹èº«' },
                { id: 'shoes', category: 'shoes', label: 'é‹å­' },
                { id: 'accessory', category: 'accessory', label: 'é…ä»¶' }
            ]);

            // selectedItems ä¿æŒä¸è®Šï¼Œå®ƒæ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œkey å°æ‡‰ slot.id
            const [selectedItems, setSelectedItems] = useState({ 
                upper: null, outerwear: null, lower: null, 
                accessory: null, hairstyle: null, shoes: null 
            }); 
            
            const [selectedUser, setSelectedUser] = useState(null);
            
            const [viewCategory, setViewCategory] = useState('all'); 
            const [uploadCategory, setUploadCategory] = useState('upper');
            const [viewSubCategory, setViewSubCategory] = useState('all');
            const [viewBrand, setViewBrand] = useState('all'); 
            const [viewTag, setViewTag] = useState('all'); 
            const [viewMode, setViewMode] = useState('grid'); 

            const [generatedResult, setGeneratedResult] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [isSelectorOpen, setIsSelectorOpen] = useState(false);
            const [currentSelectionSlot, setCurrentSelectionSlot] = useState(null);
            const [genMode, setGenMode] = useState('studio');
            const [customPromptText, setCustomPromptText] = useState('');
            const [focusMode, setFocusMode] = useState('full');

            const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);
            const [uploadFile, setUploadFile] = useState(null); 
            const [editingItem, setEditingItem] = useState(null); 
            const [selectedLook, setSelectedLook] = useState(null);

            const fileInputRefCloth = useRef(null);
            const fileInputRefUser = useRef(null);

            useEffect(() => {
                // ç•¶åˆ‡æ›ç€è¦½åˆ†é¡æ™‚ï¼ŒåŒæ­¥æ›´æ–°ä¸Šå‚³é è¨­åˆ†é¡ (ä½†é€™è£¡ä¸å†ç›´æ¥ setUploadCategoryï¼Œæ”¹ç”± Modal å…§éƒ¨è™•ç†)
                setViewSubCategory('all'); setViewBrand('all'); setViewTag('all');   
            }, [viewCategory]);

            useEffect(() => {
                const initFirebase = async () => {
                    if (!YOUR_FIREBASE_CONFIG.apiKey) return;
                    try {
                        let app; try { app = window.Firebase.initializeApp(YOUR_FIREBASE_CONFIG); } catch(e) { app = window.Firebase.getApp(); }
                        const auth = window.Firebase.getAuth(app);
                        window.Firebase.onAuthStateChanged(auth, (u) => { setAuthUser(u); setIsFirebaseReady(true); });
                    } catch (err) { console.error("Firebase Init Error:", err); }
                };
                if (window.Firebase) initFirebase();
            }, []); 

            useEffect(() => {
                if (!user || !isFirebaseReady) return;
                setIsSyncing(true);
                const db = window.Firebase.getFirestore();
                
                const fetchApiKey = async () => {
                    try {
                        const docRef = window.Firebase.doc(db, 'app_config', 'secrets');
                        const docSnap = await window.Firebase.getDoc(docRef);
                        if (docSnap.exists()) setGlobalApiKey(docSnap.data().gemini_key || '');
                    } catch (e) { }
                };
                fetchApiKey();

                const unsubSettings = window.Firebase.onSnapshot(window.Firebase.doc(db, 'users', user.uid, 'settings', 'config'), (doc) => {
                    if (doc.exists()) {
                        setUserTags(doc.data().tags || []);
                        setUserBrands(doc.data().brands || []); 
                    }
                });

                // --- é¡åº¦çµ±è¨ˆèˆ‡æ¯æ—¥æ­¸é›¶é‚è¼¯ ---
                const statsRef = window.Firebase.doc(db, 'users', user.uid, 'settings', 'stats');
                const unsubStats = window.Firebase.onSnapshot(statsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const today = new Date().toLocaleDateString('zh-TW'); // å–å¾—ä»Šæ—¥æ—¥æœŸå­—ä¸²
                        
                        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦ä¸åŒï¼Œå¦‚æœä¸åŒå‰‡é‡ç½®
                        if (data.lastReset !== today) {
                             // ä¿®æ”¹ï¼šæ¯å¤©é‡ç½®æ™‚ï¼Œå°‡ count æ­¸é›¶ï¼Œä¸¦ä¸”å°‡ limit (é¡åº¦) ä¹Ÿå¼·åˆ¶æ­¸é›¶
                             window.Firebase.setDoc(statsRef, { count: 0, limit: 0, lastReset: today }, { merge: true });
                        } 
                        
                        setGenStats({ 
                            // å¦‚æœæ—¥æœŸæ˜¯ä»Šå¤©ï¼Œä½¿ç”¨ countï¼Œå¦å‰‡è¦–ç‚º 0 (ç­‰å¾…ä¸Šé¢ setDoc ç”Ÿæ•ˆ)
                            count: (data.lastReset === today) ? (data.count || 0) : 0, 
                            // ä¿®æ”¹ï¼šåŸæœ¬ || 1 æœƒå°è‡´ 0 è®Šæˆ 1ã€‚æ”¹æˆå…è¨± 0ã€‚
                            limit: (data.limit !== undefined) ? data.limit : 0 
                        });
                    } else {
                        // åˆå§‹åŒ–
                        const today = new Date().toLocaleDateString('zh-TW');
                        // ä¿®æ”¹ï¼šåˆå§‹é¡åº¦è¨­ç‚º 0
                        window.Firebase.setDoc(statsRef, { count: 0, limit: 0, lastReset: today }, { merge: true });
                        setGenStats({ count: 0, limit: 0 });
                    }
                });

                const unsubClothes = window.Firebase.onSnapshot(window.Firebase.query(window.Firebase.collection(db, 'users', user.uid, 'clothes'), window.Firebase.orderBy('createdAt', 'desc')), (s) => setClothes(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubUsers = window.Firebase.onSnapshot(window.Firebase.query(window.Firebase.collection(db, 'users', user.uid, 'models'), window.Firebase.orderBy('createdAt', 'desc')), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubLooks = window.Firebase.onSnapshot(window.Firebase.query(window.Firebase.collection(db, 'users', user.uid, 'looks'), window.Firebase.orderBy('createdAt', 'desc')), (s) => { setLooks(s.docs.map(d => ({ id: d.id, ...d.data() }))); setIsSyncing(false); });
                
                return () => { unsubClothes(); unsubUsers(); unsubLooks(); unsubSettings(); unsubStats(); };
            }, [user, isFirebaseReady]);

            const saveApiKeyToCloud = async (key) => {
                if (!isFirebaseReady) return;
                try {
                    const db = window.Firebase.getFirestore();
                    await window.Firebase.setDoc(window.Firebase.doc(db, 'app_config', 'secrets'), { gemini_key: key }, { merge: true });
                    setGlobalApiKey(key);
                } catch (e) { alert("å„²å­˜å¤±æ•—"); }
            };

            const handleRedeem = async (code) => {
                if (!isFirebaseReady) return false;
                try {
                    const db = window.Firebase.getFirestore();
                    const codeDoc = await window.Firebase.getDoc(window.Firebase.doc(db, 'app_config', 'codes'));
                    if (codeDoc.exists() && codeDoc.data().topup_password === code) {
                        await window.Firebase.updateDoc(window.Firebase.doc(db, 'users', user.uid, 'settings', 'stats'), {
                            limit: window.Firebase.increment(5)
                        });
                        return true;
                    }
                } catch (e) { console.error(e); }
                return false;
            };

            const handleAddUserTag = async (newTag) => {
                if (!isFirebaseReady || !user) return;
                try {
                    const db = window.Firebase.getFirestore();
                    const docRef = window.Firebase.doc(db, 'users', user.uid, 'settings', 'config');
                    await window.Firebase.setDoc(docRef, { tags: window.Firebase.arrayUnion(newTag) }, { merge: true });
                } catch (err) {}
            };

            const handleDeleteUserTag = async (tagToDelete) => {
                if (!isFirebaseReady || !user) return;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ¨™ç±¤ "${tagToDelete}" å—ï¼Ÿ`)) return;
                try {
                    const db = window.Firebase.getFirestore();
                    const docRef = window.Firebase.doc(db, 'users', user.uid, 'settings', 'config');
                    await window.Firebase.updateDoc(docRef, { tags: window.Firebase.arrayRemove(tagToDelete) });
                } catch (err) {}
            };

            const handleAddUserBrand = async (newBrand) => {
                if (!isFirebaseReady || !user) return;
                try {
                    const db = window.Firebase.getFirestore();
                    const docRef = window.Firebase.doc(db, 'users', user.uid, 'settings', 'config');
                    await window.Firebase.setDoc(docRef, { brands: window.Firebase.arrayUnion(newBrand) }, { merge: true });
                } catch (err) {}
            };
            
            const handleDeleteUserBrand = async (brandToDelete) => {
                if (!isFirebaseReady || !user) return;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤å“ç‰Œ "${brandToDelete}" å—ï¼Ÿ`)) return;
                try {
                    const db = window.Firebase.getFirestore();
                    const docRef = window.Firebase.doc(db, 'users', user.uid, 'settings', 'config');
                    await window.Firebase.updateDoc(docRef, { brands: window.Firebase.arrayRemove(brandToDelete) });
                } catch (err) { console.error(err); }
            };

            const handleFileSelect = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                if (type === 'user') {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const compressedBase64 = await compressImage(reader.result, 800, 0.6);
                        const defaultName = file.name.replace(/\.[^/.]+$/, "");
                        uploadToFirebase({ name: defaultName, src: compressedBase64 }, 'models');
                    };
                    reader.readAsDataURL(file);
                } else {
                    setUploadFile(file);
                    setEditingItem(null);
                    setIsUploadModalOpen(true);
                }
            };

            const handleEditItem = (item) => {
                setUploadFile(null);
                setEditingItem(item);
                setIsUploadModalOpen(true);
            };

            const handleConfirmUpload = async (metadata) => {
                let base64Src = editingItem?.src;
                if (uploadFile) {
                    const reader = new FileReader();
                    const promise = new Promise(resolve => { reader.onloadend = () => resolve(reader.result); });
                    reader.readAsDataURL(uploadFile);
                    const rawBase64 = await promise;
                    base64Src = await compressImage(rawBase64, 800, 0.6);
                }
                if (!base64Src) return;
                const collectionName = 'clothes';
                if (isFirebaseReady && user) {
                    try {
                        const db = window.Firebase.getFirestore();
                        if (editingItem) {
                            await window.Firebase.updateDoc(window.Firebase.doc(db, 'users', user.uid, collectionName, editingItem.id), { ...metadata });
                        } else {
                            await window.Firebase.addDoc(window.Firebase.collection(db, 'users', user.uid, collectionName), { ...metadata, src: base64Src, createdAt: window.Firebase.serverTimestamp() });
                        }
                    } catch (err) { alert("æ“ä½œå¤±æ•—: " + err.message); }
                } else {
                    const newItem = { id: editingItem ? editingItem.id : Date.now(), src: base64Src, ...metadata };
                    if (editingItem) setClothes(clothes.map(c => c.id === newItem.id ? newItem : c));
                    else setClothes([newItem, ...clothes]);
                }
            };

            const uploadToFirebase = async (data, collectionName) => {
                if (isFirebaseReady && user) {
                    try {
                        const db = window.Firebase.getFirestore();
                        await window.Firebase.addDoc(window.Firebase.collection(db, 'users', user.uid, collectionName), { ...data, createdAt: window.Firebase.serverTimestamp() });
                    } catch (err) { alert("ä¸Šå‚³å¤±æ•—"); }
                } else {
                    setUsers([{ id: Date.now(), ...data }, ...users]);
                }
            };

            const handleSaveLook = async () => {
                if (!generatedResult) return;
                let compressedResult = generatedResult;
                try { compressedResult = await compressImage(generatedResult, 800, 0.6); } catch (e) {}
                
                const defaultName = `ç©¿æ­ ${new Date().toLocaleDateString()}`;
                const lookName = prompt("è¼¸å…¥ç©¿æ­åç¨±:", defaultName) || defaultName;

                const prepareItemData = (item) => {
                    if (!item) return null;
                    return { id: item.id, src: item.src, name: item.name };
                };
                
                // å‹•æ…‹æ”¶é›†æ‰€æœ‰ä½¿ç”¨åˆ°çš„ items
                const itemsUsed = { 
                    user: selectedUser ? { id: selectedUser.id, src: selectedUser.src, name: selectedUser.name } : null,
                };
                
                // éæ­· tryOnSlots ä¾†ä¿å­˜æ‰€æœ‰é¸ä¸­çš„å–®å“
                tryOnSlots.forEach(slot => {
                    if (selectedItems[slot.id]) {
                        itemsUsed[slot.id] = prepareItemData(selectedItems[slot.id]);
                    }
                });

                const lookData = { 
                    name: lookName,
                    src: compressedResult, 
                    items: itemsUsed, 
                    createdAt: isFirebaseReady ? window.Firebase.serverTimestamp() : new Date() 
                };
                
                if (isFirebaseReady && user) {
                    try {
                        const db = window.Firebase.getFirestore();
                        await window.Firebase.addDoc(window.Firebase.collection(db, 'users', user.uid, 'looks'), lookData);
                        alert("â¤ï¸ å·²ä¿å­˜åˆ°é›²ç«¯æ—¥èªŒï¼");
                    } catch (err) { 
                        if (err.code === 'invalid-argument' && err.message.includes('exceeds the maximum allowed size')) alert("ä¿å­˜å¤±æ•—ï¼šåœ–ç‰‡å¤ªå¤§");
                        else alert("ä¿å­˜å¤±æ•—: " + err.message); 
                    }
                } else {
                    const newLook = { id: Date.now(), ...lookData };
                    setLooks([newLook, ...looks]);
                    alert("â¤ï¸ å·²ä¿å­˜åˆ°æœ¬åœ°æ—¥èªŒ");
                }
            };
            
            const handleRenameLook = async (id, currentName) => {
                const newName = prompt("ç·¨è¼¯ç©¿æ­åç¨±:", currentName);
                if (newName && newName !== currentName) {
                    if (isFirebaseReady && user) {
                         try {
                            const db = window.Firebase.getFirestore();
                            await window.Firebase.updateDoc(window.Firebase.doc(db, 'users', user.uid, 'looks', id), { name: newName });
                        } catch (err) { alert("æ›´åå¤±æ•—"); }
                    } else {
                        setLooks(looks.map(l => l.id === id ? { ...l, name: newName } : l));
                    }
                }
            };

            const handleDelete = async (id, type) => {
                if (isFirebaseReady && user) {
                    const db = window.Firebase.getFirestore();
                    let collectionName = type === 'cloth' ? 'clothes' : (type === 'user' ? 'models' : 'looks');
                    await window.Firebase.deleteDoc(window.Firebase.doc(db, 'users', user.uid, collectionName, id));
                } else {
                    if (type === 'cloth') setClothes(clothes.filter(c => c.id !== id));
                    else if (type === 'user') setUsers(users.filter(u => u.id !== id));
                    else setLooks(looks.filter(l => l.id !== id));
                }
                if (type === 'cloth') { const n = { ...selectedItems }; Object.keys(n).forEach(k => { if (n[k]?.id === id) n[k] = null; }); setSelectedItems(n); }
                else if (type === 'user' && selectedUser?.id === id) setSelectedUser(null);
                if (type === 'look' && selectedLook?.id === id) setSelectedLook(null);
            };

            // ... (handleDelete å‡½å¼ä¹‹å¾Œ) ...

            // [æ–°å¢] é‚„åŸç©¿æ­åˆ°è©¦ç©¿å€
            const handleRestoreLook = (look) => {
                if (!look) return;

                // 1. é‚„åŸæ¨¡ç‰¹å…’
                if (look.items?.user) {
                    setSelectedUser(look.items.user);
                }

                // 2. é‚„åŸé¸å®šçš„è¡£ç‰©
                // ç‚ºäº†é¿å…æ··äº‚ï¼Œå…ˆå»ºç«‹ä¸€å€‹ä¹¾æ·¨çš„ stateï¼Œåªå¡«å…¥ Look ä¸­æœ‰çš„é …ç›®
                const newSelectedItems = { ...selectedItems };
                
                // å…ˆå°‡æ‰€æœ‰æ¬„ä½æ¸…ç©º (å¯é¸ï¼šå¦‚æœæ‚¨å¸Œæœ›ä¿ç•™æœªè¦†è“‹çš„é …ç›®ï¼Œå¯æ‹¿æ‰é€™æ®µè¿´åœˆ)
                Object.keys(newSelectedItems).forEach(key => {
                    newSelectedItems[key] = null;
                });

                // å¡«å…¥ Look ä¸­çš„é …ç›®
                if (look.items) {
                    Object.keys(look.items).forEach(key => {
                        if (key !== 'user' && look.items[key]) {
                            // ç›´æ¥å°‡å„²å­˜çš„ item é‚„åŸå›å»
                            newSelectedItems[key] = look.items[key];
                        }
                    });
                }
                setSelectedItems(newSelectedItems);

                // 3. è·³è½‰åˆ°è©¦ç©¿é é¢ä¸¦é—œé–‰ Modal
                setActiveTab('studio');
                setSelectedLook(null);
                
                // æç¤ºä½¿ç”¨è€…
                // å¯ä»¥é¸æ“‡æ€§åŠ å…¥ï¼šalert("å·²å°‡ç©¿æ­å¸¶å…¥è©¦ç©¿é–“ï¼");
            };

            // ... (handleAddSlot å‡½å¼ä¹‹å‰) ...

            // --- æ–°å¢ï¼šè™•ç†å¢åŠ æ¬„ä½çš„å‡½å¼ ---
            const handleAddSlot = (category, labelPrefix) => {
                const newId = `${category}_${Date.now()}`; // ç”¢ç”Ÿå”¯ä¸€ ID
                const newSlot = { 
                    id: newId, 
                    category: category, 
                    label: `${labelPrefix} ${tryOnSlots.filter(s => s.category === category).length + 1}` 
                };
                
                // æ’å…¥åˆ°é©ç•¶ä½ç½® (ä¾‹å¦‚ï¼šæ–°å¢çš„ä¸Šèº«æ”¾åœ¨æ‰€æœ‰ä¸Šèº«ä¹‹å¾Œï¼Œä½†åœ¨ä¸‹èº«ä¹‹å‰)
                const lastIndex = tryOnSlots.findLastIndex(s => s.category === category);
                const insertIndex = lastIndex >= 0 ? lastIndex + 1 : tryOnSlots.length;
                
                const newSlots = [...tryOnSlots];
                newSlots.splice(insertIndex, 0, newSlot);
                setTryOnSlots(newSlots);
            };

            // --- æ–°å¢ï¼šè™•ç†åˆªé™¤æ¬„ä½çš„å‡½å¼ (é¸æ“‡æ€§åŠŸèƒ½) ---
            const handleRemoveSlot = (slotId) => {
                setTryOnSlots(prev => prev.filter(s => s.id !== slotId));
                setSelectedItems(prev => {
                    const next = { ...prev };
                    delete next[slotId];
                    return next;
                });
            };

            const handleGenerateClick = async () => {
                if (!selectedUser) return;

                if (genStats.count >= genStats.limit) {
                    alert(`ğŸ”’ é¡åº¦å·²æ»¿ (${genStats.count}/${genStats.limit})ã€‚\n\nè«‹åœ¨è¨­å®šä¸­è¼¸å…¥ä»£ç¢¼ä»¥ç²å–æ›´å¤šé¡åº¦ã€‚`);
                    return;
                }

                setIsGenerating(true); setGeneratedResult(null); setErrorMsg('');
                try {
                    // ä¿®æ”¹é€™è£¡ï¼šå‚³å…¥æœ€å¾Œä¸€å€‹ callback å‡½å¼ä¾†æ¥æ”¶ Prompt
                    const result = await generateTryOnImage(
                        selectedUser.src, 
                        selectedItems, 
                        globalApiKey, 
                        genMode, 
                        customPromptText, 
                        focusMode, 
                        tryOnSlots,
                        (debugText) => {
                            // é€™è£¡æ”¶åˆ° Prompt å¾Œï¼Œç›´æ¥å¡«å…¥è‡ªè¨‚æ¬„ä½
                            setCustomPromptText(debugText);
                            // å¦‚æœæ‚¨å¸Œæœ›ç”Ÿæˆå¾Œè‡ªå‹•è·³è½‰åˆ°ã€Œè‡ªè¨‚æŒ‡ä»¤ã€åˆ†é ä»¥ä¾¿è§€çœ‹ï¼Œå¯å–æ¶ˆä¸‹è¡Œè¨»è§£ï¼š
                            // setGenMode('custom'); 
                        }
                    );

                    setGeneratedResult(result);
                    
                    if (isFirebaseReady) {
                        const db = window.Firebase.getFirestore();
                        const statsRef = window.Firebase.doc(db, 'users', user.uid, 'settings', 'stats');
                        await window.Firebase.updateDoc(statsRef, { count: window.Firebase.increment(1) });
                    }
                } catch (err) { setErrorMsg(err.message); } finally { setIsGenerating(false); }
            };
            
            const handleDownload = (url, name) => { const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const getCategoryLabel = (cat) => { switch(cat) { case 'all': return { text: 'å…¨éƒ¨', icon: <Icons.Grid /> }; case 'upper': return { text: 'ä¸Šèº«', icon: <Icons.Shirt /> }; case 'outerwear': return { text: 'å¤–å¥—', icon: <Icons.Jacket /> }; case 'lower': return { text: 'ä¸‹èº«', icon: <Icons.Layer /> }; case 'accessory': return { text: 'é…ä»¶', icon: <Icons.Watch /> }; case 'hairstyle': return { text: 'é«®å‹', icon: <Icons.Scissors /> }; case 'shoes': return { text: 'é‹å­', icon: <Icons.Shoes /> }; default: return { text: 'å…¶ä»–', icon: <Icons.Shirt /> }; }};
            const handleImageError = (e) => { e.target.onerror = null; e.target.src = "https://placehold.co/400x600/e2e8f0/94a3b8?text=Image+Error"; };
            const handleRenameModel = async (id, currentName) => { const newName = prompt("ç·¨è¼¯åç¨±:", currentName); if (newName && newName !== currentName) { if (isFirebaseReady && user) { try { const db = window.Firebase.getFirestore(); await window.Firebase.updateDoc(window.Firebase.doc(db, 'users', user.uid, 'models', id), { name: newName }); } catch (err) { alert("å¤±æ•—"); } } else { setUsers(users.map(u => u.id === id ? { ...u, name: newName } : u)); } } };
            const getLatestItemInfo = (snapshotItem, type) => { if (!snapshotItem) return null; if (type === 'user') { const current = users.find(u => u.id === snapshotItem.id); return current ? { ...current, src: snapshotItem.src } : snapshotItem; } else { const current = clothes.find(c => c.id === snapshotItem.id); return current ? { ...current, src: snapshotItem.src } : snapshotItem; } };

            if (!user) return <AuthScreen isFirebaseReady={isFirebaseReady} />;
            
            const allBrands = Array.from(new Set([...DEFAULT_BRANDS, ...(userBrands || [])]));

            const ListViewItem = ({ item, type, onDelete, onEdit }) => (
                <div className="flex items-center gap-4 p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                    <img src={item.src} className="w-16 h-16 rounded-md object-cover flex-shrink-0" onError={handleImageError} />
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between">
                            <h4 className="font-bold text-gray-800 truncate">{item.name}</h4>
                            <div className="flex gap-2">
                                <button onClick={(e) => { e.stopPropagation(); onEdit(item); }} className="text-gray-400 hover:text-purple-600"><div className="w-4 h-4"><Icons.Edit /></div></button>
                                <button onClick={(e) => { e.stopPropagation(); onDelete(item.id, type); }} className="text-gray-400 hover:text-red-600"><div className="w-4 h-4"><Icons.Trash /></div></button>
                            </div>
                        </div>
                        {type === 'cloth' && (
                            <div className="text-xs text-gray-500 mt-1 flex flex-wrap gap-2">
                                <span className="bg-gray-100 px-2 py-0.5 rounded">{CLOTH_CATEGORIES[item.category]?.label || item.category}</span>
                                {item.subCategory && <span className="bg-gray-100 px-2 py-0.5 rounded">{item.subCategory}</span>}
                                {item.brand && <span className="bg-blue-50 text-blue-600 px-2 py-0.5 rounded font-medium">{item.brand}</span>}
                            </div>
                        )}
                        {item.tags && item.tags.length > 0 && (<div className="flex gap-1 mt-2 overflow-x-auto scrollbar-hide">{item.tags.map(tag => <span key={tag} className="text-[10px] bg-purple-50 text-purple-600 px-1.5 py-0.5 rounded">#{tag}</span>)}</div>)}
                    </div>
                </div>
            );
            
            const LookListViewItem = ({ look }) => {
                 const hairstyle = getLatestItemInfo(look.items?.hairstyle, 'cloth');
                 // å‹•æ…‹å–å¾—æ‰€æœ‰ç©¿æ­é …ç›®
                 const clothingItems = Object.keys(look.items || {})
                     .filter(key => key !== 'user' && key !== 'hairstyle')
                     .map(key => getLatestItemInfo(look.items[key], 'cloth'))
                     .filter(Boolean);

                 return (
                    <div className="bg-white rounded-xl border border-gray-100 shadow-sm p-4 flex flex-col md:flex-row gap-4">
                        <div className="relative w-full md:w-32 aspect-[3/4] md:aspect-square flex-shrink-0 cursor-pointer" onClick={() => setSelectedLook(look)}><img src={look.src} className="w-full h-full object-cover rounded-lg" onError={handleImageError} /></div>
                        <div className="flex-1 min-w-0 flex flex-col justify-between">
                            <div className="flex justify-between items-start"><div><div className="flex items-center gap-2"><h3 className="font-bold text-lg text-gray-800">{look.name || 'æœªå‘½åç©¿æ­'}</h3><button onClick={() => handleRenameLook(look.id, look.name)} className="text-gray-400 hover:text-purple-600"><div className="w-4 h-4"><Icons.Edit /></div></button></div><p className="text-xs text-gray-400">{look.createdAt ? new Date(look.createdAt.seconds * 1000).toLocaleDateString() : 'å‰›å‰›'}</p></div><button onClick={() => handleDelete(look.id, 'look')} className="text-gray-400 hover:text-red-600"><div className="w-4 h-4"><Icons.Trash /></div></button></div>
                            <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><h5 className="text-xs font-bold text-gray-400 uppercase mb-1">ğŸ’‡ é«®å‹</h5>{hairstyle ? (<div className="flex items-center gap-2"><img src={hairstyle.src} className="w-6 h-6 rounded-full object-cover border" /><span className="text-sm text-gray-700 truncate">{hairstyle.name}</span></div>) : <span className="text-xs text-gray-300">ç„¡</span>}</div>
                                <div><h5 className="text-xs font-bold text-gray-400 uppercase mb-1">ğŸ‘• æœé£¾</h5>{clothingItems.length > 0 ? (<div className="flex flex-wrap gap-2">{clothingItems.map((item, idx) => (<div key={idx} className="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border border-gray-100 max-w-full"><span className="text-xs text-gray-700 truncate max-w-[80px]">{item.name}</span></div>))}</div>) : <span className="text-xs text-gray-300">ç„¡</span>}</div>
                            </div>
                        </div>
                    </div>
                 );
            };

            return (
                <div className="flex flex-col h-screen bg-gray-50 overflow-hidden">
                    <header className="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2"><div className="w-8 h-8 bg-gradient-to-tr from-purple-600 to-pink-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">V</div><h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600">Virtual Wardrobe</h1></div>
                        <div className="flex items-center gap-3"><div className="text-xs text-gray-400 hidden md:flex items-center gap-1">{isFirebaseReady ? (isSyncing ? "åŒæ­¥ä¸­..." : <><span className="text-green-500">â—</span> {user.displayName || user.email}</>) : <span className="text-orange-400">æœ¬åœ°æ¨¡å¼</span>}</div><button onClick={() => setShowSettings(true)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><div className="w-5 h-5 text-gray-500"><Icons.Settings /></div></button></div>
                    </header>
                    <main className="flex-1 overflow-y-auto p-4 md:p-6 max-w-5xl mx-auto w-full pb-24 z-0">
                        <div className="flex bg-white rounded-xl p-1 shadow-sm mb-6 sticky top-0 z-40 ring-1 ring-gray-100">{[{ id: 'wardrobe', icon: <Icons.Grid />, label: 'è¡£æ«¥' }, { id: 'user', icon: <Icons.User />, label: 'æ¨¡ç‰¹å…’' }, { id: 'studio', icon: <Icons.Sparkles />, label: 'è©¦ç©¿' }, { id: 'lookbook', icon: <Icons.BookHeart />, label: 'æ—¥èªŒ' }].map(tab => (<button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-3 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 ${activeTab === tab.id ? 'bg-purple-100 text-purple-700' : 'text-gray-500 hover:bg-gray-50'}`}><div className="w-5 h-5">{tab.icon}</div> <span className="hidden md:inline">{tab.label}</span></button>))}</div>
                        
                        {activeTab === 'wardrobe' && (
                            <div className="animate-fade-in">
                                <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                                    <div className="flex bg-gray-100 rounded-lg p-1 overflow-x-auto max-w-[70%] md:max-w-none scrollbar-hide">
                                        {['all', 'upper', 'outerwear', 'lower', 'shoes', 'accessory', 'hairstyle'].map(type => (
                                            <button key={type} onClick={() => setViewCategory(type)} className={`px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-colors ${viewCategory === type ? 'bg-white shadow-sm text-purple-600' : 'text-gray-500 hover:text-gray-700'}`}>{CLOTH_CATEGORIES[type]?.label || 'å…¨éƒ¨'}</button>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex items-center gap-2 w-full md:w-auto">
                                            {viewCategory !== 'all' && (<select value={viewSubCategory} onChange={e => setViewSubCategory(e.target.value)} className="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs font-medium text-gray-600 outline-none"><option value="all">æ‰€æœ‰ç¨®é¡</option>{CLOTH_CATEGORIES[viewCategory].types.map(t => <option key={t} value={t}>{t}</option>)}</select>)}
                                            <select value={viewBrand} onChange={e => setViewBrand(e.target.value)} className="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs font-medium text-gray-600 outline-none"><option value="all">æ‰€æœ‰å“ç‰Œ</option>{allBrands.map(b => <option key={b} value={b}>{b}</option>)}</select>
                                            <select value={viewTag} onChange={e => setViewTag(e.target.value)} className="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs font-medium text-gray-600 outline-none"><option value="all">æ‰€æœ‰æ¨™ç±¤</option>{userTags.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                        </div>
                                        <button onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')} className="p-2 bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200"><div className="w-5 h-5">{viewMode === 'grid' ? <Icons.List /> : <Icons.Grid />}</div></button>
                                        <button onClick={() => fileInputRefCloth.current.click()} className="flex items-center justify-center gap-2 px-6 py-2 bg-slate-900 text-white rounded-lg text-sm hover:bg-slate-800 whitespace-nowrap transition-colors"><div className="w-4 h-4"><Icons.Upload /></div> æ–°å¢å–®å“</button>
                                        <input type="file" ref={fileInputRefCloth} className="hidden" accept="image/*" onChange={(e) => handleFileSelect(e, 'cloth')} />
                                    </div>
                                </div>
                                {viewMode === 'grid' ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pb-10">
                                        {clothes.filter(item => {
                                            const catMatch = viewCategory === 'all' || item.category === viewCategory;
                                            const subMatch = viewSubCategory === 'all' || item.subCategory === viewSubCategory;
                                            const brandMatch = viewBrand === 'all' || item.brand === viewBrand;
                                            const tagMatch = viewTag === 'all' || (item.tags && item.tags.includes(viewTag));
                                            return catMatch && subMatch && brandMatch && tagMatch;
                                        }).map((item) => (
                                            <div key={item.id} className="group relative aspect-square bg-white rounded-2xl overflow-hidden border border-gray-100 shadow-sm transition-all hover:shadow-md">
                                                <img src={item.src} onError={handleImageError} className="w-full h-full object-cover" />
                                                <div className="absolute top-2 left-2 flex flex-col gap-1 items-start max-w-[80%]">
                                                    <div className="bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-1 rounded-md flex items-center gap-1"><div className="w-3 h-3">{getCategoryLabel(item.category).icon}</div>{item.subCategory || getCategoryLabel(item.category).text}</div>
                                                    {item.brand && <div className="bg-white/90 text-gray-700 text-[9px] px-2 py-0.5 rounded-md font-bold shadow-sm">{item.brand}</div>}
                                                    {item.tags && item.tags.length > 0 && (<div className="flex flex-wrap gap-1">{item.tags.slice(0, 3).map(tag => (<div key={tag} className="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded-md shadow-sm">#{tag}</div>))}</div>)}
                                                </div>
                                                <div className="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/70 to-transparent p-3 pt-6"><p className="text-white text-xs font-medium truncate">{item.name}</p></div>
                                                <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={(e) => { e.stopPropagation(); handleEditItem(item); }} className="bg-white text-slate-600 p-1.5 rounded-full hover:bg-slate-50 shadow-sm"><div className="w-3 h-3"><Icons.Edit /></div></button><button onClick={(e) => { e.stopPropagation(); handleDelete(item.id, 'cloth'); }} className="bg-white text-red-500 p-1.5 rounded-full hover:bg-red-50 shadow-sm"><div className="w-3 h-3"><Icons.Trash /></div></button></div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-3 pb-10">
                                        {clothes.filter(item => {
                                            const catMatch = viewCategory === 'all' || item.category === viewCategory;
                                            const subMatch = viewSubCategory === 'all' || item.subCategory === viewSubCategory;
                                            const brandMatch = viewBrand === 'all' || item.brand === viewBrand;
                                            const tagMatch = viewTag === 'all' || (item.tags && item.tags.includes(viewTag));
                                            return catMatch && subMatch && brandMatch && tagMatch;
                                        }).map(item => (<ListViewItem key={item.id} item={item} type="cloth" onDelete={handleDelete} onEdit={handleEditItem} />))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'user' && (<div className="animate-fade-in"><div className="flex justify-between items-center mb-6"><h2 className="text-lg font-semibold">æ¨¡ç‰¹å…’ç®¡ç†</h2><div className="flex gap-2"><button onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')} className="p-2 bg-white rounded-lg text-gray-600 hover:bg-gray-100 border border-gray-200"><div className="w-5 h-5">{viewMode === 'grid' ? <Icons.List /> : <Icons.Grid />}</div></button><button onClick={() => fileInputRefUser.current.click()} className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-full text-sm hover:bg-slate-800"><div className="w-4 h-4"><Icons.Camera /></div> ä¸Šå‚³ç…§ç‰‡</button><input type="file" ref={fileInputRefUser} className="hidden" accept="image/*" onChange={(e) => handleFileSelect(e, 'user')} /></div></div>{viewMode === 'grid' ? (<div className="grid grid-cols-2 md:grid-cols-3 gap-4 pb-10">{users.map((item) => (<div key={item.id} className="group relative aspect-[3/4] bg-white rounded-2xl overflow-hidden border border-gray-100 shadow-sm"><img src={item.src} onError={handleImageError} className="w-full h-full object-cover" /><div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 text-white text-xs font-bold">{item.name || "æˆ‘"}</div><div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => handleRenameModel(item.id, item.name)} className="bg-white text-slate-600 p-1.5 rounded-full hover:bg-slate-50 shadow-sm"><div className="w-3 h-3"><Icons.Edit /></div></button><button onClick={() => handleDelete(item.id, 'user')} className="bg-white text-red-500 p-1.5 rounded-full hover:bg-red-50 shadow-sm"><div className="w-3 h-3"><Icons.Trash /></div></button></div></div>))}</div>) : (<div className="flex flex-col gap-3 pb-10">{users.map(item => (<ListViewItem key={item.id} item={item} type="user" onDelete={handleDelete} onEdit={() => handleRenameModel(item.id, item.name)} />))}</div>)}</div>)}
                        
                        {activeTab === 'studio' && (<div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 animate-fade-in mb-10"><div className="flex flex-col lg:flex-row gap-8 justify-center items-start"><div className="w-full lg:w-1/3"><h3 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">1. é¸æ“‡æ¨¡ç‰¹å…’</h3><div className="grid grid-cols-3 gap-2">{users.map(u => (<div key={u.id} onClick={() => setSelectedUser(u)} className={`aspect-[3/4] rounded-lg overflow-hidden cursor-pointer border-2 transition-all ${selectedUser?.id === u.id ? 'border-purple-500 ring-2 ring-purple-200' : 'border-transparent opacity-70 hover:opacity-100'}`}><img src={u.src} className="w-full h-full object-cover" /></div>))}</div></div>
                            <div className="w-full lg:w-2/3">
                                {/* æ–°å¢æŒ‰éˆ•å€ï¼šå‹•æ…‹å¢åŠ æ¬„ä½ */}
                                <div className="flex justify-between items-end mb-3">
                                    <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">2. é¸æ“‡æ­é…</h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleAddSlot('upper', 'ä¸Šèº«')} className="px-2 py-1 bg-purple-50 text-purple-600 text-xs font-bold rounded hover:bg-purple-100 flex items-center gap-1"><div className="w-3 h-3"><Icons.Plus /></div> ä¸Šèº«</button>
                                        <button onClick={() => handleAddSlot('lower', 'ä¸‹èº«')} className="px-2 py-1 bg-purple-50 text-purple-600 text-xs font-bold rounded hover:bg-purple-100 flex items-center gap-1"><div className="w-3 h-3"><Icons.Plus /></div> ä¸‹èº«</button>
                                        <button onClick={() => handleAddSlot('accessory', 'é…ä»¶')} className="px-2 py-1 bg-purple-50 text-purple-600 text-xs font-bold rounded hover:bg-purple-100 flex items-center gap-1"><div className="w-3 h-3"><Icons.Plus /></div> é…ä»¶</button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {/* ä½¿ç”¨ tryOnSlots ç‹€æ…‹ä¾†æ¸²æŸ“æ¬„ä½ */}
                                    {tryOnSlots.map(slot => (
                                        <div key={slot.id} onClick={() => { setCurrentSelectionSlot(slot.id); setIsSelectorOpen(true); }} className={`group relative h-32 rounded-xl border-2 border-dashed flex flex-col items-center justify-center cursor-pointer transition-all hover:bg-gray-50 ${selectedItems[slot.id] ? 'border-purple-500 bg-purple-50' : 'border-gray-300'}`}>
                                            {selectedItems[slot.id] ? (
                                                <div className="relative w-full h-full p-2">
                                                    <img src={selectedItems[slot.id].src} className="w-full h-full object-contain" />
                                                    <button onClick={(e) => { e.stopPropagation(); setSelectedItems(p => ({...p, [slot.id]: null})); }} className="absolute top-1 right-1 bg-white text-gray-500 rounded-full p-1 shadow-md hover:text-red-500"><div className="w-3 h-3"><Icons.X /></div></button>
                                                    <span className="absolute bottom-1 left-0 right-0 text-[10px] text-center text-purple-700 font-bold bg-white/80">{selectedItems[slot.id].name || slot.label}</span>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="w-6 h-6 text-gray-300 mb-1">{getCategoryLabel(slot.category).icon}</div>
                                                    <span className="text-xs text-gray-400">{slot.label}</span>
                                                    {/* åˆªé™¤æŒ‰éˆ• (åƒ…é‡å°å¾Œä¾†æ–°å¢çš„æ¬„ä½ï¼Œé€™è£¡åˆ¤æ–·å¦‚æœæ˜¯é è¨­çš„å¹¾å€‹åŸºæœ¬æ¬„ä½å‰‡ä¸é¡¯ç¤ºï¼Œç°¡å–®èµ·è¦‹å¯å…¨éƒ¨å…è¨±æˆ–åˆ¤æ–· ID) */}
                                                    {slot.id.includes('_') && (
                                                        <button onClick={(e) => { e.stopPropagation(); handleRemoveSlot(slot.id); }} className="absolute top-1 right-1 text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><div className="w-3 h-3"><Icons.X /></div></button>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div><div className="mt-8 bg-gray-50 p-4 rounded-xl border border-gray-100"><h3 className="text-sm font-bold text-gray-600 mb-3 flex items-center gap-2"><div className="w-4 h-4"><Icons.Settings /></div> ç”Ÿæˆè¨­å®š</h3><div className="flex flex-col gap-4"><div className="flex bg-white p-1 rounded-lg border border-gray-200"><button onClick={() => setFocusMode('full')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${focusMode === 'full' ? 'bg-slate-800 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-100'}`}><div className="w-4 h-4"><Icons.Body /></div> å…¨èº«æœé£¾</button><button onClick={() => setFocusMode('face')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex items-center justify-center gap-2 ${focusMode === 'face' ? 'bg-slate-800 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-100'}`}><div className="w-4 h-4"><Icons.Eye /></div> è‡‰éƒ¨é«®å‹ç‰¹å¯«</button></div><div className="flex gap-2">{[{ id: 'studio', label: 'âœ¨ æ¨™æº–æ£šæ‹' }, { id: 'minimal', label: 'ğŸ›¡ï¸ æœ€å°è®ŠåŒ–' }, { id: 'custom', label: 'âœï¸ è‡ªè¨‚æŒ‡ä»¤' }].map(mode => (<button key={mode.id} onClick={() => setGenMode(mode.id)} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${genMode === mode.id ? 'bg-white shadow-sm border border-purple-200 text-purple-700' : 'text-gray-500 hover:bg-gray-200'}`}>{mode.label}</button>))}</div>{genMode === 'custom' && (<textarea value={customPromptText} onChange={(e) => setCustomPromptText(e.target.value)} placeholder="è¼¸å…¥è‡ªè¨‚å ´æ™¯..." className="w-full p-3 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-purple-200 outline-none resize-none h-20" />)}<p className="text-xs text-gray-400 pl-1">{focusMode === 'face' ? 'ğŸ’¡ ç‰¹å¯«æ¨¡å¼ï¼šAI å°‡å°ˆæ³¨æ–¼èåˆé«®å‹èˆ‡è‡‰éƒ¨ï¼Œå¿½ç•¥ä¸‹åŠèº«ç©¿æ­ã€‚' : 'ğŸ’¡ å…¨èº«æ¨¡å¼ï¼šå±•ç¤ºæ•´é«”ç©¿æ­æ•ˆæœï¼ŒåŒ…å«é‹å­ã€‚'}</p></div></div><div className="mt-6 flex justify-center"><button disabled={!selectedUser || isGenerating} onClick={handleGenerateClick} className={`px-10 py-4 rounded-full font-bold text-lg shadow-xl w-full md:w-auto flex items-center justify-center gap-2 transition-transform active:scale-95 ${!selectedUser ? 'bg-gray-200 text-gray-400' : 'bg-gradient-to-r from-purple-600 to-pink-500 text-white hover:shadow-purple-500/30'}`}>{isGenerating ? <><div className="w-5 h-5"><Icons.Loader /></div> è™•ç†ä¸­...</> : <><div className="w-5 h-5"><Icons.Sparkles /></div> ç”Ÿæˆè©¦ç©¿ç…§</>}</button></div>{(generatedResult || errorMsg) && (<div className="mt-8 pt-8 border-t border-gray-100 flex flex-col items-center animate-slide-up">{errorMsg ? <div className="p-4 bg-red-50 text-red-600 rounded-xl text-center border border-red-100">{errorMsg}</div> : <div className="flex flex-col items-center gap-4 w-full"><h3 className="font-bold text-gray-700">ç”Ÿæˆçµæœ</h3><img src={generatedResult} className="rounded-xl shadow-2xl w-full max-w-sm" /><div className="flex gap-3"><button onClick={() => handleDownload(generatedResult, `tryon-${Date.now()}.jpg`)} className="px-6 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm font-bold flex items-center gap-2 transition-colors"><div className="w-4 h-4"><Icons.Download /></div> ä¸‹è¼‰</button><button onClick={handleSaveLook} className="px-6 py-2 bg-pink-100 hover:bg-pink-200 text-pink-700 rounded-full text-sm font-bold flex items-center gap-2 transition-colors"><div className="w-4 h-4"><Icons.SaveHeart /></div> ä¿å­˜åˆ°æ—¥èªŒ</button></div></div>}</div>)}</div>)}
                        
                        {activeTab === 'lookbook' && (<div className="animate-fade-in"><div className="flex justify-between items-center mb-6"><h2 className="text-lg font-semibold">ç©¿æ­æ—¥èªŒ</h2><button onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')} className="p-2 bg-white rounded-lg text-gray-600 hover:bg-gray-100 border border-gray-200"><div className="w-5 h-5">{viewMode === 'grid' ? <Icons.List /> : <Icons.Grid />}</div></button></div>{looks.length === 0 ? <div className="text-center py-20 text-gray-400 bg-white rounded-2xl border-2 border-dashed border-gray-200"><div className="w-16 h-16 mx-auto mb-4 opacity-20"><Icons.BookHeart /></div><p>é‚„æ²’æœ‰ä¿å­˜çš„ç©¿æ­</p></div> : (viewMode === 'grid' ? <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">{looks.map((look) => (<div key={look.id} onClick={() => setSelectedLook(look)} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col cursor-pointer hover:shadow-md transition-shadow"><div className="relative aspect-[3/4] bg-gray-50 group"><img src={look.src} className="w-full h-full object-cover" /><div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center"><span className="opacity-0 group-hover:opacity-100 bg-white/90 text-gray-700 text-xs px-3 py-1.5 rounded-full font-bold shadow-sm">æŸ¥çœ‹è©³æƒ…</span></div></div><div className="p-4 flex justify-between items-center bg-white border-t border-gray-50"><span className="text-xs text-gray-400">{look.createdAt ? new Date(look.createdAt.seconds * 1000).toLocaleDateString() : 'å‰›å‰›'}</span><button onClick={(e) => { e.stopPropagation(); handleDelete(look.id, 'look'); }} className="text-red-400 hover:text-red-600 p-1.5 rounded-full hover:bg-red-50"><div className="w-4 h-4"><Icons.Trash /></div></button></div></div>))}</div> : <div className="flex flex-col gap-4 pb-10">{looks.map(look => <LookListViewItem key={look.id} look={look} />)}</div>)}</div>)}
                        
                        {/* ä¿®æ­£é¸æ“‡å™¨ (Selector)ï¼šä½¿ç”¨ tryOnSlots å°‹æ‰¾å°æ‡‰çš„åˆ†é¡ */}
                        {isSelectorOpen && (<div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setIsSelectorOpen(false)}><div className="bg-white w-full md:w-[600px] h-[70vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden m-4" onClick={e => e.stopPropagation()}><div className="p-4 border-b flex justify-between items-center bg-gray-50"><h3 className="font-bold">é¸æ“‡{tryOnSlots.find(s => s.id === currentSelectionSlot)?.label || 'ç‰©å“'}</h3><button onClick={() => setIsSelectorOpen(false)}><div className="w-6 h-6"><Icons.X /></div></button></div><div className="flex-1 overflow-y-auto p-4 bg-white">
                            {(() => {
                                const targetCategory = tryOnSlots.find(s => s.id === currentSelectionSlot)?.category || currentSelectionSlot;
                                const filteredClothes = clothes.filter(c => c.category === targetCategory);
                                
                                if (filteredClothes.length === 0) return <div className="h-full flex flex-col items-center justify-center text-gray-400 gap-2"><p>æ²’æœ‰é€™å€‹åˆ†é¡çš„ç‰©å“</p><button onClick={() => { setIsSelectorOpen(false); setIsUploadModalOpen(true); }} className="text-purple-600 font-bold">å»æ–°å¢</button></div>;
                                
                                return <div className="grid grid-cols-3 gap-3">{filteredClothes.map(item => (<div key={item.id} onClick={() => { setSelectedItems(p => ({...p, [currentSelectionSlot]: item})); setIsSelectorOpen(false); }} className="cursor-pointer aspect-square bg-white rounded-xl border-2 border-transparent hover:border-purple-500 overflow-hidden shadow-sm relative"><img src={item.src} className="w-full h-full object-cover" /><div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] p-1 truncate">{item.name}</div></div>))}</div>;
                            })()}
                        </div></div></div>)}
                        
                        {showSettings && <SettingsModal onClose={() => setShowSettings(false)} user={user} isFirebaseReady={isFirebaseReady} apiKey={globalApiKey} onSaveApiKey={saveApiKeyToCloud} genStats={genStats} onRedeem={handleRedeem} userBrands={userBrands} onDeleteBrand={handleDeleteUserBrand} userTags={userTags} onDeleteTag={handleDeleteUserTag} />}
                        {isUploadModalOpen && <UploadEditorModal isOpen={isUploadModalOpen} onClose={() => setIsUploadModalOpen(false)} file={uploadFile} isEdit={!!editingItem} initialData={editingItem} onConfirm={handleConfirmUpload} userTags={userTags} onAddTag={handleAddUserTag} onDeleteTag={handleDeleteUserTag} userBrands={userBrands} onAddBrand={handleAddUserBrand} defaultCategory={viewCategory} />}
                        {selectedLook && <LookDetailsModal isOpen={!!selectedLook} onClose={() => setSelectedLook(null)} look={selectedLook} lookName={selectedLook.name} onRename={handleRenameLook} onRestore={handleRestoreLook} />}
                    </main>
                    <footer className="py-6 text-center text-gray-400 text-xs">Created by weic58 and Google Gemini, 2026</footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VirtualWardrobe />);
    </script>
</body>
</html>
